name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check shell scripts (exclude archive)
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck
        find . -name "*.sh" -type f -not -path "./archive/*" -exec shellcheck {} \;
    
    - name: Check YAML files (exclude archive)
      run: |
        pip install yamllint
        find . \( -name "*.yml" -o -name "*.yaml" \) -not -path "./archive/*" | xargs yamllint -d relaxed
    
    - name: Check Markdown files (respect ignore file)
      uses: docker://avtodev/markdown-lint:v1
      with:
        args: '**/*.md --ignore-path .markdownlintignore'

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'config'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  test-docker-compose:
    name: Test Docker Compose
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate docker-compose files (module + base)
      run: |
        for file in config/compose/*.yml; do
          echo "Validating $file..."
          if [ "$(basename "$file")" = "base.yml" ]; then
            docker compose -f "$file" config > /dev/null
          else
            docker compose -f config/compose/base.yml -f "$file" config > /dev/null
          fi
        done
    
    - name: Check for secrets in code
      run: |
        if grep -r "password\s*=\s*['\"][^'\"]*['\"]" config/ scripts/ --include="*.sh" --include="*.ps1" --include="*.yml"; then
          echo "Found hardcoded passwords!"
          exit 1
        fi
        echo "No hardcoded passwords found."

  build-test:
    name: Build and Basic Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create .env file
      run: |
        cp config/.env.example config/.env
        sed -i 's/CHANGE_ME/test_password_123/g' config/.env
    
    - name: Start core services (base + core)
      run: |
        # Запускаем базу + core для теста
        docker compose -f config/compose/base.yml -f config/compose/core.yml up -d
        sleep 30
    
    - name: Check services health
      run: |
        docker compose -f config/compose/base.yml -f config/compose/core.yml ps
        # Проверяем что PostgreSQL и Redis живы
        docker compose -f config/compose/base.yml -f config/compose/core.yml exec -T postgres pg_isready || exit 1
        docker compose -f config/compose/base.yml -f config/compose/core.yml exec -T redis redis-cli ping || exit 1
    
    - name: Cleanup
      if: always()
      run: |
        docker compose -f config/compose/base.yml -f config/compose/core.yml down -v
