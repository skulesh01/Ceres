# Persistent Volume конфигурация для K3s
# Local Path Provisioner для хранилища на узлах кластера

apiVersion: v1
kind: Namespace
metadata:
  name: kube-system

---
# Local Path Provisioner
apiVersion: v1
kind: ConfigMap
metadata:
  name: local-path-config
  namespace: kube-system
data:
  config.json: |
    {
      "nodePathMap": [
        {
          "node": "DEFAULT_PATH_FOR_NON_LISTED_NODES",
          "paths": [
            "/var/lib/rancher/k3s/storage"
          ]
        }
      ],
      "sharedFileSystemPath": "/var/lib/rancher/k3s/storage",
      "storageUUID": "ceres-k3s-storage",
      "troubleshoot": false,
      "helperPod": {
        "enabled": true,
        "image": "rancher/local-path-provisioner:latest"
      }
    }

---
# Storage Class для Database (PostgreSQL)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ceres-database
  namespace: kube-system
provisioner: rancher.io/local-path
allowVolumeExpansion: true
reclaimPolicy: Retain
volumeBindingMode: WaitForFirstConsumer
parameters:
  replicaCount: "3"
  fsType: ext4
  diskType: ssd

---
# Storage Class для Cache (Redis)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ceres-cache
  namespace: kube-system
provisioner: rancher.io/local-path
allowVolumeExpansion: true
reclaimPolicy: Retain
volumeBindingMode: WaitForFirstConsumer
parameters:
  replicaCount: "2"
  fsType: ext4

---
# Storage Class для File Storage (Nextcloud)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ceres-files
  namespace: kube-system
provisioner: rancher.io/local-path
allowVolumeExpansion: true
reclaimPolicy: Retain
volumeBindingMode: WaitForFirstConsumer
parameters:
  fsType: ext4

---
# Storage Class для Logs (Loki)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ceres-logs
  namespace: kube-system
provisioner: rancher.io/local-path
allowVolumeExpansion: true
reclaimPolicy: Delete
volumeBindingMode: WaitForFirstConsumer
parameters:
  fsType: ext4

---
# PersistentVolume для PostgreSQL узел-1
apiVersion: v1
kind: PersistentVolume
metadata:
  name: postgres-pv-1
  namespace: ceres
spec:
  capacity:
    storage: 100Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: ceres-database
  local:
    path: /data/postgres/node-1
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - worker-1

---
# PersistentVolume для PostgreSQL узел-2
apiVersion: v1
kind: PersistentVolume
metadata:
  name: postgres-pv-2
  namespace: ceres
spec:
  capacity:
    storage: 100Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: ceres-database
  local:
    path: /data/postgres/node-2
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - worker-2

---
# PersistentVolume для PostgreSQL узел-3
apiVersion: v1
kind: PersistentVolume
metadata:
  name: postgres-pv-3
  namespace: ceres
spec:
  capacity:
    storage: 100Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: ceres-database
  local:
    path: /data/postgres/node-3
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - worker-3

---
# PersistentVolume для Redis узел-1
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-pv-1
  namespace: ceres
spec:
  capacity:
    storage: 50Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: ceres-cache
  local:
    path: /data/redis/node-1
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - worker-1

---
# PersistentVolume для Redis узел-2
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-pv-2
  namespace: ceres
spec:
  capacity:
    storage: 50Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: ceres-cache
  local:
    path: /data/redis/node-2
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - worker-2

---
# PersistentVolume для Redis узел-3
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-pv-3
  namespace: ceres
spec:
  capacity:
    storage: 50Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: ceres-cache
  local:
    path: /data/redis/node-3
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - worker-3

---
# PersistentVolume для Nextcloud
apiVersion: v1
kind: PersistentVolume
metadata:
  name: nextcloud-pv
  namespace: ceres
spec:
  capacity:
    storage: 200Gi
  accessModes:
  - ReadWriteMany  # Нужен NFS или подобный
  persistentVolumeReclaimPolicy: Retain
  storageClassName: ceres-files
  local:
    path: /data/nextcloud

---
# PersistentVolume для Gitea
apiVersion: v1
kind: PersistentVolume
metadata:
  name: gitea-pv
  namespace: ceres
spec:
  capacity:
    storage: 100Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: ceres-database
  local:
    path: /data/gitea

---
# PersistentVolume для Loki (logs)
apiVersion: v1
kind: PersistentVolume
metadata:
  name: loki-pv
  namespace: monitoring
spec:
  capacity:
    storage: 50Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  storageClassName: ceres-logs
  local:
    path: /data/loki

---
# PersistentVolume для Prometheus (metrics)
apiVersion: v1
kind: PersistentVolume
metadata:
  name: prometheus-pv
  namespace: monitoring
spec:
  capacity:
    storage: 100Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: ceres-database
  local:
    path: /data/prometheus
