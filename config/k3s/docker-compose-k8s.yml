# Kompose configuration для преобразования Docker Compose → Kubernetes
# Автоматическая конвертация compose файлов в K8s манифесты

version: '3.8'

services:
  
  # PostgreSQL с StatefulSet и persistent storage
  postgres:
    image: postgres:15-alpine
    labels:
      kompose.service.type: statefulset
      kompose.volume.size: 100Gi
      kompose.volume.storage-class: ceres-database
    environment:
      POSTGRES_DB: ceres_db
      POSTGRES_USER: ceres_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./config/postgresql/rls-policies.sql:/docker-entrypoint-initdb.d/10-rls.sql
      - ./config/postgresql/patroni-config.yml:/etc/patroni/patroni.yml
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ceres_user -d ceres_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always
    networks:
      - ceres-network

  # Redis с StatefulSet
  redis:
    image: redis:7-alpine
    labels:
      kompose.service.type: statefulset
      kompose.volume.size: 50Gi
      kompose.volume.storage-class: ceres-cache
    command:
      - redis-server
      - --appendonly yes
      - --requirepass ${REDIS_PASSWORD}
      - --maxmemory 4gb
      - --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always
    networks:
      - ceres-network

  # Keycloak с StatefulSet и HA
  keycloak:
    image: quay.io/keycloak/keycloak:24.0.0
    labels:
      kompose.service.type: deployment
      kompose.replicas: 3
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_PASSWORD}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/ceres_db
      KC_DB_USERNAME: ceres_user
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD}
      KC_PROXY: edge
      KC_PROXY_ADDRESS_FORWARDING: "true"
      KC_HTTP_ENABLED: "true"
      KC_HEALTH_ENABLED: "true"
      KC_CACHE: ispn
      KC_CACHE_CONFIG_FILE: cache-ispn-jdbc-ping.xml
    ports:
      - "8080:8080"
    command:
      - start
      - --optimized
      - --db postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      postgres:
        condition: service_healthy
    restart: always
    networks:
      - ceres-network

  # Nginx Ingress с multi-tenancy
  nginx:
    image: nginx:1.25-alpine
    labels:
      kompose.service.type: deployment
      kompose.replicas: 3
    ports:
      - "80:80"
      - "443:443"
      - "8404:8404"  # HAProxy stats
    volumes:
      - ./config/nginx/tenant-routing.conf:/etc/nginx/conf.d/default.conf:ro
      - ./config/caddy/Caddyfile:/etc/nginx/ssl/Caddyfile:ro
      - /etc/certs:/etc/nginx/certs:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      - keycloak
    restart: always
    networks:
      - ceres-network

  # Nextcloud с StatefulSet
  nextcloud:
    image: nextcloud:28-fpm-alpine
    labels:
      kompose.service.type: statefulset
      kompose.volume.size: 200Gi
      kompose.volume.storage-class: ceres-database
    environment:
      NEXTCLOUD_ADMIN_USER: ${NEXTCLOUD_ADMIN}
      NEXTCLOUD_ADMIN_PASSWORD: ${NEXTCLOUD_PASSWORD}
      POSTGRES_DB: nextcloud_db
      POSTGRES_USER: nextcloud_user
      POSTGRES_PASSWORD: ${NEXTCLOUD_DB_PASSWORD}
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
      TRUSTED_PROXIES: "*"
    volumes:
      - nextcloud_data:/var/www/html
      - nextcloud_config:/var/www/html/config
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: always
    networks:
      - ceres-network

  # Gitea с StatefulSet
  gitea:
    image: gitea/gitea:1.21-alpine
    labels:
      kompose.service.type: statefulset
      kompose.volume.size: 100Gi
      kompose.volume.storage-class: ceres-database
    environment:
      USER_UID: 1000
      USER_GID: 1000
      DB_TYPE: postgres
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: gitea_user
      DB_PASSWD: ${GITEA_DB_PASSWORD}
      DB_NAME: gitea_db
      DOMAIN: gitea.ceres.local
      SSH_DOMAIN: gitea.ceres.local
      ROOT_URL: http://gitea.ceres.local/
      RUN_MODE: prod
    ports:
      - "3000:3000"
      - "222:22"
    volumes:
      - gitea_data:/data
    depends_on:
      postgres:
        condition: service_healthy
    restart: always
    networks:
      - ceres-network

  # Mattermost с StatefulSet
  mattermost:
    image: mattermost/mattermost-team-edition:9.2
    labels:
      kompose.service.type: statefulset
      kompose.volume.size: 50Gi
    environment:
      MATTERMOST_SQLSETTINGS_DATASOURCE: "postgres://mattermost_user:${MATTERMOST_DB_PASSWORD}@postgres:5432/mattermost_db?sslmode=disable"
      MATTERMOST_SQLSETTINGS_DRIVERNAME: postgres
      MATTERMOST_LOGSETTINGS_ENABLEFILE: "true"
      MATTERMOST_LOGSETTINGS_FILELOCATION: /mattermost/logs
      MM_SQLSETTINGS_DATASOURCE: "postgres://mattermost_user:${MATTERMOST_DB_PASSWORD}@postgres:5432/mattermost_db?sslmode=disable"
      MM_SQLSETTINGS_DRIVERNAME: postgres
    ports:
      - "8000:8000"
    volumes:
      - mattermost_data:/mattermost/data
      - mattermost_logs:/mattermost/logs
    depends_on:
      postgres:
        condition: service_healthy
    restart: always
    networks:
      - ceres-network

  # Redmine с StatefulSet
  redmine:
    image: redmine:5.0-alpine
    labels:
      kompose.service.type: statefulset
      kompose.volume.size: 50Gi
    environment:
      REDMINE_DB_MYSQL: postgres
      REDMINE_DB_USERNAME: redmine_user
      REDMINE_DB_PASSWORD: ${REDMINE_DB_PASSWORD}
      REDMINE_DB_DATABASE: redmine_db
      REDMINE_RELATIVE_URL_ROOT: /redmine
    ports:
      - "3001:3000"
    volumes:
      - redmine_data:/usr/src/redmine/files
    depends_on:
      postgres:
        condition: service_healthy
    restart: always
    networks:
      - ceres-network

  # Wiki.js с StatefulSet
  wikijs:
    image: requarks/wiki:2.5
    labels:
      kompose.service.type: statefulset
      kompose.volume.size: 50Gi
    environment:
      DB: postgres
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: wikijs_user
      DB_PASS: ${WIKIJS_DB_PASSWORD}
      DB_NAME: wikijs_db
    ports:
      - "3002:3000"
    volumes:
      - wikijs_data:/wiki/data
    depends_on:
      postgres:
        condition: service_healthy
    restart: always
    networks:
      - ceres-network

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  nextcloud_data:
    driver: local
  nextcloud_config:
    driver: local
  gitea_data:
    driver: local
  mattermost_data:
    driver: local
  mattermost_logs:
    driver: local
  redmine_data:
    driver: local
  wikijs_data:
    driver: local

networks:
  ceres-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
