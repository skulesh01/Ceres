# K3s Cluster Configuration для CERES
# Легковесный Kubernetes кластер с поддержкой multi-tenancy
# Deployment: 3 мастер ноды + N worker ноды

---
# Namespace для CERES
apiVersion: v1
kind: Namespace
metadata:
  name: ceres
  labels:
    app: ceres
    environment: production

---
# Namespace для monitoring
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
  labels:
    app: monitoring

---
# Namespace для multi-tenancy
apiVersion: v1
kind: Namespace
metadata:
  name: tenants
  labels:
    app: tenants
    multi-tenant: "true"

---
# ServiceAccount для CERES
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ceres
  namespace: ceres

---
# ClusterRole для CERES
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: ceres-admin
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]
- nonResourceURLs: ["*"]
  verbs: ["*"]

---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ceres-admin
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ceres-admin
subjects:
- kind: ServiceAccount
  name: ceres
  namespace: ceres

---
# ConfigMap с K3s конфигурацией
apiVersion: v1
kind: ConfigMap
metadata:
  name: k3s-config
  namespace: ceres
data:
  k3s-init.sh: |
    #!/bin/bash
    set -e
    
    # K3s установка
    export K3S_TOKEN=ceres-cluster-token
    export K3S_URL=https://master-0.ceres.local:6443
    export INSTALL_K3S_VERSION=v1.29.1
    
    # Мастер ноды (control-plane + etcd)
    # Запуск на master-0, master-1, master-2
    
    if [ "$NODE_TYPE" = "master" ]; then
      curl -sfL https://get.k3s.io | K3S_TOKEN=$K3S_TOKEN \
        INSTALL_K3S_VERSION=$INSTALL_K3S_VERSION \
        K3S_DATASTORE_ENDPOINT="postgres://pguser:pgpass@postgres.ceres.local:5432/k3s" \
        K3S_DATASTORE_CAFILE=/etc/ceres/ca.crt \
        K3S_DATASTORE_CERTFILE=/etc/ceres/cert.crt \
        K3S_DATASTORE_KEYFILE=/etc/ceres/key.key \
        K3S_SERVER_ARGS="--cluster-init \
          --disable traefik \
          --disable servicelb \
          --disable metrics-server \
          --kube-apiserver-arg=feature-gates=EphemeralContainers=true \
          --kube-controller-manager-arg=feature-gates=ExpandedDNSConfig=true \
          --kubelet-arg=max-pods=200" \
        sh -
    fi
    
    # Worker ноды
    if [ "$NODE_TYPE" = "worker" ]; then
      curl -sfL https://get.k3s.io | K3S_TOKEN=$K3S_TOKEN \
        K3S_URL=$K3S_URL \
        INSTALL_K3S_VERSION=$INSTALL_K3S_VERSION \
        K3S_AGENT_ARGS="--kubelet-arg=max-pods=200 \
          --kubelet-arg=system-reserved=cpu=500m,memory=512Mi" \
        sh -
    fi
    
    # Ждем готовности кластера
    kubectl wait --for=condition=Ready node --all --timeout=300s 2>/dev/null || true
    
    # Инициализация RBAC и network policy
    kubectl apply -f /etc/ceres/rbac-config.yml
    kubectl apply -f /etc/ceres/network-policies.yml
    kubectl apply -f /etc/ceres/storage-config.yml

  network-policies.yml: |
    # Network Policy для изоляции тенантов
    apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: tenant-isolation
      namespace: tenants
    spec:
      podSelector: {}
      policyTypes:
      - Ingress
      - Egress
      ingress:
      - from:
        - namespaceSelector:
            matchLabels:
              tenant-id: ${TENANT_ID}
        - podSelector:
            matchLabels:
              app: ingress-nginx
      egress:
      - to:
        - namespaceSelector:
            matchLabels:
              tenant-id: ${TENANT_ID}
      - to:
        - namespaceSelector:
            matchLabels:
              app: kube-system
        ports:
        - protocol: TCP
          port: 53  # DNS
      - to:
        - podSelector:
            matchLabels:
              app: postgres
        ports:
        - protocol: TCP
          port: 5432

  storage-config.yml: |
    # Local Path Provisioner для хранилища
    apiVersion: storage.k8s.io/v1
    kind: StorageClass
    metadata:
      name: local-path
      namespace: kube-system
    provisioner: rancher.io/local-path
    reclaimPolicy: Delete
    volumeBindingMode: WaitForFirstConsumer
    parameters:
      paths: "/var/lib/rancher/k3s/storage"

    ---
    # StatefulSet storage для PostgreSQL
    apiVersion: storage.k8s.io/v1
    kind: StorageClass
    metadata:
      name: ceres-database
    provisioner: rancher.io/local-path
    reclaimPolicy: Retain
    volumeBindingMode: WaitForFirstConsumer
    parameters:
      paths: "/data/postgres"

    ---
    # Redis persistent storage
    apiVersion: storage.k8s.io/v1
    kind: StorageClass
    metadata:
      name: ceres-cache
    provisioner: rancher.io/local-path
    reclaimPolicy: Retain
    volumeBindingMode: WaitForFirstConsumer
    parameters:
      paths: "/data/redis"

---
# K3s Cluster Configuration (ConfigMap)
apiVersion: v1
kind: ConfigMap
metadata:
  name: k3s-startup-config
  namespace: ceres
data:
  cluster-info.json: |
    {
      "cluster_name": "ceres-k3s",
      "version": "1.29.1",
      "ha_enabled": true,
      "nodes": {
        "control_plane": 3,
        "worker": 3
      },
      "features": {
        "ingress": "nginx",
        "storage": "local-path",
        "monitoring": "prometheus",
        "networking": "cilium",
        "multi_tenancy": true,
        "pod_security_standards": "restricted",
        "network_policies": true
      },
      "resource_limits": {
        "master_cpu": "4",
        "master_memory": "8Gi",
        "worker_cpu": "8",
        "worker_memory": "16Gi"
      }
    }

  k3s-helm-values.yml: |
    # Helm значения для K3s компонентов
    ingress-nginx:
      enabled: true
      controller:
        replicas: 3
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        config:
          use-forwarded-headers: "true"
          use-proxy-protocol: "false"
          real-ip-header: "X-Forwarded-For"
          enable-modsecurity: "true"
          enable-owasp-core-rules: "true"
        service:
          type: NodePort
          externalTrafficPolicy: Local

    cert-manager:
      enabled: true
      installCRDs: true
      global:
        leaderElection:
          namespace: kube-system

    metrics-server:
      enabled: true
      args:
        - --kubelet-insecure-tls
        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname

    prometheus:
      enabled: true
      namespace: monitoring
      retention: 30d
      storage: 100Gi

    loki:
      enabled: true
      namespace: monitoring
      retention: 7d
      storage: 50Gi
