groups:
  - name: ceres_slo
    interval: 30s
    rules:
      # Request latency SLO
      - record: slo:request_latency_p99:5m
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))
      
      - record: slo:request_latency_p95:5m
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))
      
      - record: slo:request_latency_p50:5m
        expr: histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))
      
      # Error rate SLO
      - record: slo:error_rate:5m
        expr: rate(http_requests_total{status=~"5.."}[5m])
      
      - record: slo:success_rate:5m
        expr: 1 - (rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]))
      
      # Availability SLO
      - record: slo:availability:5m
        expr: avg(up{job=~"ceres-.*"})
      
      # Throughput SLO
      - record: slo:throughput:5m
        expr: rate(http_requests_total[5m])
      
      # Database latency SLO
      - record: slo:db_query_latency_p99:5m
        expr: histogram_quantile(0.99, rate(postgres_query_duration_seconds_bucket[5m]))
      
      - record: slo:db_connection_pool_usage:5m
        expr: rate(pg_stat_activity_count[5m]) / 100

  - name: ceres_alerts
    interval: 30s
    rules:
      # SLO violation alerts
      - alert: HighLatency
        expr: slo:request_latency_p99:5m > 1.0
        for: 5m
        labels:
          severity: warning
          component: application
        annotations:
          summary: "High request latency detected"
          description: "P99 latency is {{ $value }}s (threshold: 1.0s)"
      
      - alert: HighErrorRate
        expr: slo:error_rate:5m > 0.05
        for: 5m
        labels:
          severity: critical
          component: application
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
      
      - alert: ServiceUnavailable
        expr: slo:availability:5m < 0.95
        for: 5m
        labels:
          severity: critical
          component: infrastructure
        annotations:
          summary: "Service availability below SLA"
          description: "Availability is {{ $value | humanizePercentage }} (SLA: 95%)"
      
      # Database alerts
      - alert: HighDatabaseLatency
        expr: slo:db_query_latency_p99:5m > 0.5
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "High database latency"
          description: "DB P99 latency is {{ $value }}s"
      
      - alert: DatabaseConnectionPoolAlmostFull
        expr: slo:db_connection_pool_usage:5m > 0.8
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Database connection pool usage high"
          description: "Connection pool usage is {{ $value | humanizePercentage }}"
      
      # Resource alerts
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes / 1024 / 1024 / 1024 > 7.5
        for: 5m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is {{ $value }}GB"
      
      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total[5m]) > 3.5
        for: 5m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is {{ $value }} cores"

  - name: ceres_sla_tracking
    interval: 1m
    rules:
      # Monthly uptime tracking
      - record: sla:uptime_monthly
        expr: avg_over_time(slo:availability:5m[30d]) * 100
      
      # Monthly error budget
      - record: sla:error_budget_remaining
        expr: (1 - 0.05) * 43200 - (sum(rate(http_requests_total{status=~"5.."}[30m])) * 43200)
      
      # Availability SLA compliance
      - record: sla:compliant
        expr: sla:uptime_monthly >= 95

  - name: ceres_cost_tracking
    interval: 5m
    rules:
      # Memory cost (assume $0.0001 per GB per minute)
      - record: cost:memory_per_minute
        expr: sum(container_memory_usage_bytes) / 1024 / 1024 / 1024 * 0.0001
      
      # CPU cost (assume $0.00005 per CPU per minute)
      - record: cost:cpu_per_minute
        expr: sum(rate(container_cpu_usage_seconds_total[5m])) * 0.00005
      
      # Storage cost (assume $0.0002 per GB per minute)
      - record: cost:storage_per_minute
        expr: sum(container_fs_usage_bytes) / 1024 / 1024 / 1024 * 0.0002
      
      # Total cost
      - record: cost:total_per_minute
        expr: cost:memory_per_minute + cost:cpu_per_minute + cost:storage_per_minute
      
      # Hourly cost
      - record: cost:total_per_hour
        expr: cost:total_per_minute * 60
      
      # Daily cost
      - record: cost:total_per_day
        expr: cost:total_per_hour * 24
      
      # Monthly cost
      - record: cost:total_per_month
        expr: cost:total_per_day * 30
