groups:
  - name: ceres_alerts
    interval: 30s
    rules:
      # ===================================================================
      # INFRASTRUCTURE ALERTS
      # ===================================================================
      - alert: HighCPUUsage
        expr: (100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage detected on {{ $labels.instance }}"
          description: "CPU usage is {{ $value }}%"

      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ $value }}%"

      - alert: DiskSpaceRunningOut
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.lxcfs|squashfs|vfat"} / node_filesystem_size_bytes) * 100 < 10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Low disk space on {{ $labels.device }}"
          description: "Available disk space is {{ $value }}%"

      # ===================================================================
      # SERVICE HEALTH ALERTS
      # ===================================================================
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL service is not responding"

      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis is down"
          description: "Redis service is not responding"

      - alert: KeycloakDown
        expr: up{job="keycloak"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Keycloak SSO is down"
          description: "Keycloak service is not responding"

      - alert: TraefikDown
        expr: up{job="traefik"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Traefik reverse proxy is down"
          description: "Traefik service is not responding"

      # ===================================================================
      # DATABASE ALERTS
      # ===================================================================
      - alert: PostgreSQLHighConnections
        expr: pg_stat_activity_count > 180
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL connection pool near limit"
          description: "Active connections: {{ $value }}"

      - alert: PostgreSQLSlowQueries
        expr: pg_slow_queries > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL has slow queries"
          description: "Number of slow queries: {{ $value }}"

      - alert: PostgreSQLWALArchiveFailing
        expr: pg_wal_archive_wal_failed > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL WAL archiving failing"
          description: "Failed WAL archives: {{ $value }}"

      # ===================================================================
      # CONTAINER ALERTS
      # ===================================================================
      - alert: ContainerHighMemory
        expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes * 100) > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Container {{ $labels.name }} high memory usage"
          description: "Memory usage: {{ $value }}% of limit"

      - alert: ContainerRestarting
        expr: increase(container_last_seen{restart_count!="0"}[5m]) > 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Container {{ $labels.name }} is restarting"
          description: "Container restarted {{ $value }} times in 5 minutes"

      - alert: ContainerDown
        expr: up{job=~"cadvisor|prometheus"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Container monitoring service down"
          description: "{{ $labels.job }} is not responding"

      # ===================================================================
      # APPLICATION ALERTS
      # ===================================================================
      - alert: KeycloakHighResponseTime
        expr: histogram_quantile(0.95, keycloak_http_request_duration_seconds_bucket) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Keycloak high response time"
          description: "95th percentile response time: {{ $value }}s"

      - alert: TaigaDown
        expr: up{job="taiga"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Taiga project management is down"
          description: "Taiga service is not responding"

      - alert: NextcloudDown
        expr: up{job="nextcloud"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Nextcloud file storage is down"
          description: "Nextcloud service is not responding"

      # ===================================================================
      # NETWORK ALERTS
      # ===================================================================
      - alert: HighNetworkLatency
        expr: histogram_quantile(0.95, rate(node_network_transmit_errs_total[5m])) > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High network latency detected"
          description: "Network errors: {{ $value }}"

      - alert: NetworkInterfaceDown
        expr: node_network_up == 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Network interface down on {{ $labels.instance }}"
          description: "Interface {{ $labels.device }} is down"

