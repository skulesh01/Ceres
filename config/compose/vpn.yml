# CERES Compose Module: vpn
# Purpose: self-host VPN for employee access from the Internet (WireGuard)
# NOTE: Requires inbound UDP port forwarding (default 51820) to this host.

services:
  wg-easy:
    image: ghcr.io/wg-easy/wg-easy:latest
    hostname: wg-easy
    environment:
      # Required: public IP/DNS name employees will connect to
      WG_HOST: ${WG_HOST:?Set WG_HOST in config/.env}

      # wg-easy admin UI password hash (bcrypt)
      # NOTE: Recent wg-easy versions reject PASSWORD and require PASSWORD_HASH.
      PASSWORD_HASH: ${WG_EASY_PASSWORD_HASH:?Set WG_EASY_PASSWORD_HASH in config/.env (generated by start.ps1 when vpn module is selected)}

      # WireGuard settings
      WG_PORT: 51820
      WG_DEFAULT_ADDRESS: 10.8.0.x
      WG_DEFAULT_DNS: ${WG_DEFAULT_DNS:-1.1.1.1}
      WG_ALLOWED_IPS: 10.8.0.0/24
      WG_PERSISTENT_KEEPALIVE: 25

    volumes:
      - wg_easy_data:/etc/wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1

    # Expose WireGuard UDP to the Internet.
    # Admin UI is localhost-only by default.
    ports:
      - "51820:51820/udp"
      - "127.0.0.1:51821:51821"

    networks:
      - internal
    restart: unless-stopped

networks:

volumes:
  wg_easy_data:
