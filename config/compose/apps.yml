# CERES Compose Module: apps
# Purpose: end-user applications with integrated SSO, files, git, chat, monitoring

services:
  # ============================================================================
  # KEYCLOAK - Identity & Access Management (OIDC/SAML Provider)
  # ============================================================================
  keycloak:
    image: quay.io/keycloak/keycloak@sha256:8e38bc8a4e0606e38a37401422dfbf414e2b73797952dfe94c9b56e2f9207897
    hostname: keycloak
    command: start-dev
    ports:
      - "8080:8080"  # Direct web access (for initial setup + debugging)
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:?Set KEYCLOAK_ADMIN_PASSWORD in config/.env}
      KC_DB: postgres
      KC_DB_URL_HOST: postgres
      KC_DB_URL_PORT: 5432
      KC_DB_URL_DATABASE: keycloak_db
      KC_DB_USERNAME: postgres
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD}
      KC_PROXY: edge
      KC_HOSTNAME: auth.${DOMAIN:-ceres.local}
      KC_HOSTNAME_STRICT: "false"
      KC_PROXY_ADDRESS_FORWARDING: "true"
      KC_HTTP_ENABLED: "true"
      KC_HTTP_PORT: 8080
      # Enable user caching with Redis
      KC_CACHE: ispn
      KC_CACHE_STACK: kubernetes
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -sf http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1G
        reservations:
          cpus: '0.75'
          memory: 512M
    networks:
      - internal
    restart: unless-stopped
    labels:
      # Metadata for automated discovery
      "ceres.service": "auth"
      "ceres.port": "8080"
      "ceres.url": "http://keycloak:8080"

  # ============================================================================
  # NEXTCLOUD - File Storage & Collaboration
  # ============================================================================
  nextcloud:
    image: nextcloud@sha256:48b5cc1237da4886d0222098b7252316e141bebde37f37268771518d092e7ad4
    hostname: nextcloud
    ports:
      - "8082:80"  # Direct web access
    extra_hosts:
      - "keycloak.lvh.me:host-gateway"
    environment:
      # Admin credentials
      NEXTCLOUD_ADMIN_USER: ${NEXTCLOUD_ADMIN:-admin}
      NEXTCLOUD_ADMIN_PASSWORD: ${NEXTCLOUD_ADMIN_PASSWORD:?Set NEXTCLOUD_ADMIN_PASSWORD in config/.env}
      
      # Domain & URL configuration
      NEXTCLOUD_TRUSTED_DOMAINS: "nextcloud.${DOMAIN:-ceres.local},localhost:8082,127.0.0.1:8082"
      OVERWRITEHOST: "nextcloud.${DOMAIN:-ceres.local}"
      OVERWRITEPROTOCOL: "https"
      OVERWRITECLIURL: "https://nextcloud.${DOMAIN:-ceres.local}"
      TRUSTED_PROXIES: "172.16.0.0/12,10.0.0.0/8"
      
      # Database configuration
      POSTGRES_HOST: postgres
      POSTGRES_DB: nextcloud_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      
      # Redis session caching
      REDIS_HOST: redis
      REDIS_PORT: 6379
      
      # OIDC/Keycloak integration (auto-setup via plugin)
      NEXTCLOUD_ENABLE_OAUTH2: "true"
      OIDC_PROVIDER: "https://auth.${DOMAIN:-ceres.local}"
      
      # Performance tuning
      NEXTCLOUD_DEFAULT_PHONE_REGION: "RU"
    volumes:
      - nextcloud_data:/var/www/html
      - nextcloud_config:/var/www/html/config
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/status.php"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1.5G
        reservations:
          cpus: '0.75'
          memory: 768M
    networks:
      - internal
    restart: unless-stopped
    labels:
      "ceres.service": "files"
      "ceres.port": "8082"
      "ceres.url": "http://nextcloud:80"

  # ============================================================================
  # GITLAB - Git Repository Management with OIDC Integration
  # ============================================================================
  gitlab-db-init:
    image: postgres:16-alpine
    command: >
      sh -c '
      until pg_isready -h postgres -U postgres; do sleep 1; done;
      PGPASSWORD=$$POSTGRES_PASSWORD psql -h postgres -U postgres -tc "SELECT 1 FROM pg_database WHERE datname = ''gitlab_db''" | grep -q 1 || PGPASSWORD=$$POSTGRES_PASSWORD psql -h postgres -U postgres -c "CREATE DATABASE gitlab_db ENCODING=''UTF8''";
      echo "Database ready"
      '
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - internal
    restart: "no"

  gitlab:
    image: gitlab/gitlab-ce:latest
    hostname: gitlab
    ports:
      - "8081:80"        # HTTP web access
      - "8444:443"       # HTTPS web access (self-signed)
      - "2222:22"        # SSH git+ssh access
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        # Hostname & URLs
        external_url 'https://gitlab.${DOMAIN:-ceres.local}'
        
        # Database
        gitlab_rails['db_adapter'] = 'postgresql'
        gitlab_rails['db_host'] = 'postgres'
        gitlab_rails['db_port'] = 5432
        gitlab_rails['db_database'] = 'gitlab_db'
        gitlab_rails['db_username'] = 'postgres'
        gitlab_rails['db_password'] = '${POSTGRES_PASSWORD}'
        
        # Redis session store & cache
        gitlab_rails['redis_host'] = 'redis'
        gitlab_rails['redis_port'] = 6379
        
        # OIDC Integration with Keycloak
        gitlab_rails['omniauth_enabled'] = true
        gitlab_rails['omniauth_allow_single_sign_on'] = ['openid_connect']
        gitlab_rails['omniauth_auto_link_saml_user'] = true
        gitlab_rails['omniauth_providers'] = [
          {
            'name' => 'openid_connect',
            'label' => 'Keycloak',
            'args' => {
              'name' => 'openid_connect',
              'scope' => ['openid', 'profile', 'email'],
              'response_type' => 'code',
              'issuer' => 'http://keycloak:8080/auth/realms/master',
              'discovery' => true,
              'client_auth_method' => 'query',
              'uid_field' => 'preferred_username',
              'client_options' => {
                'identifier' => 'gitlab',
                'secret' => '${GITLAB_OIDC_SECRET:-CHANGE_ME}',
                'redirect_uri' => 'https://gitlab.${DOMAIN:-ceres.local}/users/auth/openid_connect/callback'
              }
            }
          }
        ]
        
        # SSH configuration
        gitlab_rails['gitlab_shell_ssh_port'] = 2222
        gitlab_rails['gitlab_shell_ssh_host'] = 'gitlab.${DOMAIN:-ceres.local}'
        
        # Disable registration by default (Keycloak handles auth)
        gitlab_rails['gitlab_signup_enabled'] = false
        
        # SMTP (optional)
        gitlab_rails['smtp_enable'] = ${SMTP_ENABLED:-false}
        gitlab_rails['smtp_address'] = '${SMTP_HOST}'
        gitlab_rails['smtp_port'] = ${SMTP_PORT:-587}
        gitlab_rails['smtp_user_name'] = '${SMTP_USER}'
        gitlab_rails['smtp_password'] = '${SMTP_PASSWORD}'
        gitlab_rails['smtp_domain'] = '${DOMAIN:-ceres.local}'
        gitlab_rails['smtp_authentication'] = 'plain'
        gitlab_rails['smtp_enable_starttls_auto'] = true
        
        # Performance tuning
        gitlab_rails['content_security_policy_directives'] = {
          'default-src' => ["'self'"]
        }
        nginx['client_max_body_size'] = '500m'
        unicorn['worker_timeout'] = 60
        
        # Metrics collection (for Grafana)
        prometheus_monitoring['enable'] = true
        gitlab_rails['monitoring_whitelist'] = ['127.0.0.1', '0.0.0.0/0']
        
        # Allow HTTP from reverse proxy
        nginx['listen_port'] = 80
        nginx['redirect_http_to_https'] = false
    volumes:
      - gitlab_config:/etc/gitlab
      - gitlab_logs:/var/log/gitlab
      - gitlab_data:/var/opt/gitlab
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      gitlab-db-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost/-/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    networks:
      - internal
    restart: unless-stopped
    labels:
      "ceres.service": "git"
      "ceres.port": "8081"
      "ceres.url": "http://gitlab:80"
      "ceres.ssh": "gitlab.${DOMAIN:-ceres.local}:2222"

  # ============================================================================
  # MATTERMOST - Team Chat & Collaboration
  # ============================================================================
  mattermost:
    image: mattermost/mattermost-team-edition:latest
    hostname: mattermost
    ports:
      - "8085:8000"  # Web UI
    environment:
      MM_SQLSETTINGS_DATASOURCE: "postgres://postgres:${POSTGRES_PASSWORD}@postgres:5432/mattermost_db?sslmode=disable"
      MM_SQLSETTINGS_DRIVERNAME: "postgres"
      MM_SERVICESETTINGS_SITEURL: "https://chat.${DOMAIN:-ceres.local}"
      MM_SERVICESETTINGS_ENABLEOPENSERVER: "true"
      MM_SERVICESETTINGS_ALLOWCORSFROM: "*"
      
      # OIDC Integration with Keycloak
      MM_LOGINSETTINGS_ENABLEOPENSERVER: "true"
      MM_LOGINSETTINGS_ENABLEOAUTH: "true"
      MM_LOGINSETTINGS_OAUTH_OPENID_ENABLED: "true"
      MM_LOGINSETTINGS_OAUTH_OPENID_DISCOVERYENDPOINT: "http://keycloak:8080/auth/realms/master/.well-known/openid-configuration"
      MM_LOGINSETTINGS_OAUTH_OPENID_CLIENTID: "mattermost"
      MM_LOGINSETTINGS_OAUTH_OPENID_CLIENTSECRET: "${MM_OIDC_SECRET:-CHANGE_ME}"
      MM_LOGINSETTINGS_OAUTH_OPENID_SCOPE: "openid profile email"
      MM_LOGINSETTINGS_OAUTH_OPENID_AUTHENDPOINT: "http://keycloak:8080/auth/realms/master/protocol/openid-connect/auth"
      MM_LOGINSETTINGS_OAUTH_OPENID_TOKENENDPOINT: "http://keycloak:8080/auth/realms/master/protocol/openid-connect/token"
      MM_LOGINSETTINGS_OAUTH_OPENID_USERENDPOINT: "http://keycloak:8080/auth/realms/master/protocol/openid-connect/userinfo"
      MM_LOGINSETTINGS_OAUTH_OPENID_USERNAMECLAIM: "preferred_username"
      MM_LOGINSETTINGS_OAUTH_OPENID_DISPLAYNAMECLAIM: "name"
      MM_LOGINSETTINGS_OAUTH_OPENID_EMAILCLAIM: "email"
      
      # File storage
      MM_FILESETTINGS_MAXFILESIZE: 52428800  # 50MB
      MM_FILESETTINGS_ENABLEPUBLICLINK: "true"
      
      # Email notifications
      MM_EMAILSETTINGS_ENABLESIGNUPWITHEMAIL: "true"
      MM_EMAILSETTINGS_ENABLESIGNUPWITHGITHUB: "false"
      MM_EMAILSETTINGS_REQUIREEMAILVERIFICATION: "false"
      MM_EMAILSETTINGS_SMTPSERVER: "${SMTP_HOST}"
      MM_EMAILSETTINGS_SMTPPORT: ${SMTP_PORT:-587}
      MM_EMAILSETTINGS_SMTPUSERNAME: "${SMTP_USER}"
      MM_EMAILSETTINGS_SMTPPASSWORD: "${SMTP_PASSWORD}"
      MM_EMAILSETTINGS_CONNECTSECURITY: "TLS"
      
    volumes:
      - mattermost_data:/mattermost/data
      - mattermost_logs:/mattermost/logs
      - mattermost_config:/mattermost/config
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v4/system/ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    networks:
      - internal
    restart: unless-stopped
    labels:
      "ceres.service": "chat"
      "ceres.port": "8085"
      "ceres.url": "http://mattermost:8000"

  # ============================================================================
  # REDMINE - Project Management & Issue Tracking
  # ============================================================================
  redmine-db-init:
    image: postgres:16-alpine
    command: >
      sh -c '
      until pg_isready -h postgres -U postgres; do sleep 1; done;
      PGPASSWORD=$$POSTGRES_PASSWORD psql -h postgres -U postgres -tc "SELECT 1 FROM pg_database WHERE datname = ''redmine_db''" | grep -q 1 || PGPASSWORD=$$POSTGRES_PASSWORD psql -h postgres -U postgres -c "CREATE DATABASE redmine_db ENCODING=''UTF8''";
      echo "Database ready"
      '
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - internal
    restart: "no"

  redmine:
    image: redmine:5-alpine
    hostname: redmine
    ports:
      - "8083:3000"  # Web UI
    environment:
      REDMINE_DB_POSTGRES: postgres
      REDMINE_DB_PORT: 5432
      REDMINE_DB_DATABASE: redmine_db
      REDMINE_DB_USERNAME: postgres
      REDMINE_DB_PASSWORD: ${POSTGRES_PASSWORD}
      REDMINE_SECRET_KEY_BASE: ${REDMINE_SECRET_KEY:-please_change_this_to_a_long_random_string}
      
      # OIDC via OpenID Connect (Keycloak)
      REDMINE_PLUGINS_AUTH_OPENID_CONNECT_URL: "http://keycloak:8080/auth/realms/master"
      REDMINE_PLUGINS_AUTH_OPENID_CONNECT_CLIENT_ID: "redmine"
      REDMINE_PLUGINS_AUTH_OPENID_CONNECT_CLIENT_SECRET: "${REDMINE_OIDC_SECRET:-CHANGE_ME}"
      
      # Email notifications
      REDMINE_MAIL_DELIVERY_METHOD: "smtp"
      REDMINE_MAIL_SMTP_ADDRESS: "${SMTP_HOST}"
      REDMINE_MAIL_SMTP_PORT: ${SMTP_PORT:-587}
      REDMINE_MAIL_SMTP_DOMAIN: "${DOMAIN:-ceres.local}"
      REDMINE_MAIL_SMTP_USER_NAME: "${SMTP_USER}"
      REDMINE_MAIL_SMTP_PASSWORD: "${SMTP_PASSWORD}"
      REDMINE_MAIL_SMTP_AUTHENTICATION: "plain"
      REDMINE_MAIL_SMTP_ENABLE_STARTTLS_AUTO: "true"
      REDMINE_MAIL_FROM: "redmine@${DOMAIN:-ceres.local}"
      
    volumes:
      - redmine_data:/usr/src/redmine/files
      - redmine_plugins:/usr/src/redmine/plugins
    depends_on:
      postgres:
        condition: service_healthy
      redmine-db-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    networks:
      - internal
    restart: unless-stopped
    labels:
      "ceres.service": "pm"
      "ceres.port": "8083"
      "ceres.url": "http://redmine:3000"

  # ============================================================================
  # WIKI.JS - Knowledge Base & Documentation Platform
  # ============================================================================
  wikijs-db-init:
    image: postgres@sha256:aa7b1ef595e165f0b780162e3a41edd0a7ed3ea672eb8a0f81615ba725e62bc5
    command:
      - sh
      - -lc
      - |
        set -e
        echo "Ensuring wikijs_db exists..."
        export PGPASSWORD="${POSTGRES_PASSWORD}"
        if psql -h postgres -U postgres -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname='wikijs_db'" | grep -q 1; then
          echo "wikijs_db already exists."
        else
          psql -h postgres -U postgres -d postgres -c "CREATE DATABASE wikijs_db;"
          echo "Created wikijs_db."
        fi
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - internal
    restart: "no"

  wikijs:
    image: ghcr.io/requarks/wiki@sha256:1eaa2de751c2925871a95a02e0ddbdd5c48bf2e016653b2e4a8f0c646cc4ff83
    hostname: wikijs
    ports:
      - "8084:3000"  # Web UI
      - "8444:3443"  # HTTPS (self-signed)
    environment:
      DB_TYPE: postgres
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASS: ${POSTGRES_PASSWORD}
      DB_NAME: wikijs_db
      
      # Public URL configuration
      WIKI_URL_REWRITE_ENABLE: "true"
      WIKI_URL: "https://wiki.${DOMAIN:-ceres.local}"
      
      # OIDC Integration with Keycloak
      WIKI_OAUTH_ENABLE: "true"
      WIKI_OAUTH_PROVIDER: "openid"
      WIKI_OAUTH_CLIENT_ID: "wikijs"
      WIKI_OAUTH_CLIENT_SECRET: "${WIKIJS_OIDC_SECRET:-CHANGE_ME}"
      WIKI_OAUTH_AUTH_URL: "http://keycloak:8080/auth/realms/master/protocol/openid-connect/auth"
      WIKI_OAUTH_TOKEN_URL: "http://keycloak:8080/auth/realms/master/protocol/openid-connect/token"
      WIKI_OAUTH_USERINFO_URL: "http://keycloak:8080/auth/realms/master/protocol/openid-connect/userinfo"
      WIKI_OAUTH_LOGOUT_URL: "http://keycloak:8080/auth/realms/master/protocol/openid-connect/logout"
      WIKI_OAUTH_SCOPE: "openid profile email"
      WIKI_OAUTH_USERNAME_CLAIM: "preferred_username"
      WIKI_OAUTH_EMAIL_CLAIM: "email"
      WIKI_OAUTH_DISPLAY_NAME_CLAIM: "name"
      WIKI_OAUTH_MAP_GROUPS: "true"
      WIKI_OAUTH_GROUP_CLAIM: "groups"
      
      # Admin user (fallback)
      WIKI_ADMIN_EMAIL: "admin@${DOMAIN:-ceres.local}"
      
    depends_on:
      wikijs-db-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/graphql"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    networks:
      - internal
    restart: unless-stopped
    labels:
      "ceres.service": "wiki"
      "ceres.port": "8084"
      "ceres.url": "http://wikijs:3000"

networks:
  internal:
    external: true

volumes:
  nextcloud_data:
  nextcloud_config:
  gitlab_config:
  gitlab_logs:
  gitlab_data:
  mattermost_data:
  mattermost_logs:
  mattermost_config:
  redmine_data:
  redmine_plugins:
