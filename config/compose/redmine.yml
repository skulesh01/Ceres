# CERES Compose Module: redmine
# Purpose: Redmine project management (replacement for Taiga)

services:
  redmine:
    image: redmine:5-alpine
    hostname: redmine
    environment:
      REDMINE_DB_POSTGRES: postgres
      REDMINE_DB_PORT: 5432
      REDMINE_DB_DATABASE: redmine_db
      REDMINE_DB_USERNAME: postgres
      REDMINE_DB_PASSWORD: ${POSTGRES_PASSWORD}
      REDMINE_SECRET_KEY_BASE: ${REDMINE_SECRET_KEY:-please_change_this_to_a_long_random_string}
    volumes:
      - redmine_data:/usr/src/redmine/files
      - redmine_plugins:/usr/src/redmine/plugins
    depends_on:
      postgres:
        condition: service_healthy
      redmine-db-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    networks:
      - internal
    restart: unless-stopped

  redmine-db-init:
    image: postgres:16-alpine
    command: >
      sh -c '
      until pg_isready -h postgres -U postgres; do sleep 1; done;
      PGPASSWORD=$$POSTGRES_PASSWORD psql -h postgres -U postgres -tc "SELECT 1 FROM pg_database WHERE datname = ''redmine_db''" | grep -q 1 || PGPASSWORD=$$POSTGRES_PASSWORD psql -h postgres -U postgres -c "CREATE DATABASE redmine_db ENCODING=''UTF8''";
      echo "Database ready"
      '
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - internal
    restart: "no"

networks:
  internal:
    external: true

volumes:
  redmine_data:
  redmine_plugins:
