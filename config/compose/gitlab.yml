version: '3.8'

services:
  gitlab:
    image: gitlab/gitlab-ce:latest
    container_name: gitlab
    hostname: gitlab.ceres
    restart: unless-stopped
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'https://gitlab.ceres'
        
        # PostgreSQL
        gitlab_rails['db_adapter'] = 'postgresql'
        gitlab_rails['db_encoding'] = 'utf8'
        gitlab_rails['db_host'] = 'postgres'
        gitlab_rails['db_port'] = 5432
        gitlab_rails['db_database'] = 'gitlab'
        gitlab_rails['db_username'] = 'gitlab'
        gitlab_rails['db_password'] = ENV['GITLAB_DB_PASSWORD']
        
        # Redis
        gitlab_rails['redis_host'] = 'redis'
        gitlab_rails['redis_port'] = 6379
        gitlab_rails['redis_password'] = ENV['REDIS_PASSWORD']
        
        # Email (SMTP via Mailu)
        gitlab_rails['smtp_enable'] = true
        gitlab_rails['smtp_address'] = 'mail.ceres'
        gitlab_rails['smtp_port'] = 587
        gitlab_rails['smtp_user_name'] = 'gitlab@ceres'
        gitlab_rails['smtp_password'] = ENV['GITLAB_SMTP_PASSWORD']
        gitlab_rails['smtp_domain'] = 'ceres'
        gitlab_rails['smtp_authentication'] = 'login'
        gitlab_rails['smtp_enable_starttls_auto'] = true
        gitlab_rails['gitlab_email_from'] = 'gitlab@ceres'
        gitlab_rails['gitlab_email_reply_to'] = 'noreply@ceres'
        
        # OIDC (Keycloak)
        gitlab_rails['omniauth_enabled'] = true
        gitlab_rails['omniauth_allow_single_sign_on'] = ['openid_connect']
        gitlab_rails['omniauth_block_auto_created_users'] = false
        gitlab_rails['omniauth_auto_link_user'] = ['openid_connect']
        gitlab_rails['omniauth_providers'] = [
          {
            name: 'openid_connect',
            label: 'Keycloak SSO',
            args: {
              name: 'openid_connect',
              scope: ['openid', 'profile', 'email'],
              response_type: 'code',
              issuer: 'https://auth.ceres/realms/ceres',
              client_auth_method: 'query',
              discovery: true,
              uid_field: 'sub',
              client_options: {
                identifier: 'gitlab',
                secret: ENV['GITLAB_OIDC_SECRET'],
                redirect_uri: 'https://gitlab.ceres/users/auth/openid_connect/callback'
              }
            }
          }
        ]
        
        # Container Registry
        registry_external_url 'https://registry.ceres'
        gitlab_rails['registry_enabled'] = true
        
        # CI/CD
        gitlab_rails['gitlab_default_projects_features_builds'] = true
        
        # Monitoring
        prometheus['enable'] = true
        prometheus['listen_address'] = '0.0.0.0:9090'
        
        # Disable built-in PostgreSQL and Redis
        postgresql['enable'] = false
        redis['enable'] = false
    ports:
      - "8080:80"
      - "8443:443"
      - "2222:22"
    volumes:
      - gitlab_config:/etc/gitlab
      - gitlab_logs:/var/log/gitlab
      - gitlab_data:/var/opt/gitlab
    networks:
      - ceres_net
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/-/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s

volumes:
  gitlab_config:
  gitlab_logs:
  gitlab_data:

networks:
  ceres_net:
    external: true
