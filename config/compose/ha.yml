version: '3.9'

services:
  # ==================== PostgreSQL HA with Patroni ====================
  etcd:
    image: quay.io/coreos/etcd:v3.5.9
    container_name: ceres-etcd
    networks:
      - core
    environment:
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd:2380
      - ETCD_INITIAL_CLUSTER=etcd=http://etcd:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster
      - ETCD_AUTO_COMPACTION_RETENTION=1
      - ETCD_DATA_DIR=/etcd-data
    volumes:
      - ceres-etcd-data:/etcd-data
    ports:
      - "2379:2379"
      - "2380:2380"
    healthcheck:
      test: ["CMD", "etcdctl", "--endpoints=http://localhost:2379", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  postgres-1:
    image: postgres:15-alpine
    container_name: ceres-postgres-1
    networks:
      - core
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: postgres
      PATRONI_SCOPE: ceres-pg-cluster
      PATRONI_NAME: postgres-1
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:8008
      PATRONI_POSTGRESQL_DATA_DIR: /var/lib/postgresql/data
      PATRONI_POSTGRESQL_PGPASS: /tmp/pgpass
      PATRONI_POSTGRESQL_PARAMETERS: "max_connections=500"
      PATRONI_ETcd_HOSTS: "etcd:2379"
      PATRONI_POSTGRESQL_LISTEN: "0.0.0.0:5432"
    volumes:
      - ceres-postgres-1-data:/var/lib/postgresql/data
      - ./patroni/patroni.yml:/etc/patroni/patroni.yml:ro
    ports:
      - "5432:5432"
      - "8008:8008"
    depends_on:
      etcd:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  postgres-2:
    image: postgres:15-alpine
    container_name: ceres-postgres-2
    networks:
      - core
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: postgres
      PATRONI_SCOPE: ceres-pg-cluster
      PATRONI_NAME: postgres-2
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:8008
      PATRONI_POSTGRESQL_DATA_DIR: /var/lib/postgresql/data
      PATRONI_ETcd_HOSTS: "etcd:2379"
      PATRONI_POSTGRESQL_LISTEN: "0.0.0.0:5432"
    volumes:
      - ceres-postgres-2-data:/var/lib/postgresql/data
      - ./patroni/patroni.yml:/etc/patroni/patroni.yml:ro
    ports:
      - "5433:5432"
      - "8009:8008"
    depends_on:
      etcd:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  postgres-3:
    image: postgres:15-alpine
    container_name: ceres-postgres-3
    networks:
      - core
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: postgres
      PATRONI_SCOPE: ceres-pg-cluster
      PATRONI_NAME: postgres-3
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:8008
      PATRONI_POSTGRESQL_DATA_DIR: /var/lib/postgresql/data
      PATRONI_ETcd_HOSTS: "etcd:2379"
      PATRONI_POSTGRESQL_LISTEN: "0.0.0.0:5432"
    volumes:
      - ceres-postgres-3-data:/var/lib/postgresql/data
      - ./patroni/patroni.yml:/etc/patroni/patroni.yml:ro
    ports:
      - "5434:5432"
      - "8010:8008"
    depends_on:
      etcd:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ==================== Redis Sentinel ====================
  redis-1:
    image: redis:7-alpine
    container_name: ceres-redis-1
    networks:
      - core
    command: redis-server --port 6379 --requirepass ${REDIS_PASSWORD} --appendonly yes --maxmemory 512m --maxmemory-policy allkeys-lru
    volumes:
      - ceres-redis-1-data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis-2:
    image: redis:7-alpine
    container_name: ceres-redis-2
    networks:
      - core
    command: redis-server --port 6379 --requirepass ${REDIS_PASSWORD} --appendonly yes --maxmemory 512m --maxmemory-policy allkeys-lru --slaveof redis-1 6379
    volumes:
      - ceres-redis-2-data:/data
    ports:
      - "6380:6379"
    depends_on:
      - redis-1
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis-3:
    image: redis:7-alpine
    container_name: ceres-redis-3
    networks:
      - core
    command: redis-server --port 6379 --requirepass ${REDIS_PASSWORD} --appendonly yes --maxmemory 512m --maxmemory-policy allkeys-lru --slaveof redis-1 6379
    volumes:
      - ceres-redis-3-data:/data
    ports:
      - "6381:6379"
    depends_on:
      - redis-1
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis-sentinel-1:
    image: redis:7-alpine
    container_name: ceres-redis-sentinel-1
    networks:
      - core
    command: redis-sentinel /etc/redis-sentinel/sentinel.conf --port 26379
    volumes:
      - ./redis/sentinel.conf:/etc/redis-sentinel/sentinel.conf:ro
      - ceres-sentinel-1-data:/data
    ports:
      - "26379:26379"
    depends_on:
      - redis-1
      - redis-2
      - redis-3
    environment:
      - REDIS_MASTER_HOST=redis-1
      - REDIS_SENTINEL_PASSWORD=${REDIS_SENTINEL_PASSWORD}
      - REDIS_SENTINEL_IP=redis-sentinel-1
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "26379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis-sentinel-2:
    image: redis:7-alpine
    container_name: ceres-redis-sentinel-2
    networks:
      - core
    command: redis-sentinel /etc/redis-sentinel/sentinel.conf --port 26379
    volumes:
      - ./redis/sentinel.conf:/etc/redis-sentinel/sentinel.conf:ro
      - ceres-sentinel-2-data:/data
    ports:
      - "26380:26379"
    depends_on:
      - redis-1
      - redis-2
      - redis-3
    environment:
      - REDIS_MASTER_HOST=redis-1
      - REDIS_SENTINEL_PASSWORD=${REDIS_SENTINEL_PASSWORD}
      - REDIS_SENTINEL_IP=redis-sentinel-2
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "26379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis-sentinel-3:
    image: redis:7-alpine
    container_name: ceres-redis-sentinel-3
    networks:
      - core
    command: redis-sentinel /etc/redis-sentinel/sentinel.conf --port 26379
    volumes:
      - ./redis/sentinel.conf:/etc/redis-sentinel/sentinel.conf:ro
      - ceres-sentinel-3-data:/data
    ports:
      - "26381:26379"
    depends_on:
      - redis-1
      - redis-2
      - redis-3
    environment:
      - REDIS_MASTER_HOST=redis-1
      - REDIS_SENTINEL_PASSWORD=${REDIS_SENTINEL_PASSWORD}
      - REDIS_SENTINEL_IP=redis-sentinel-3
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "26379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ==================== HAProxy Load Balancer ====================
  haproxy:
    image: haproxy:2.8-alpine
    container_name: ceres-haproxy
    networks:
      - core
      - apps
      - monitoring
    command: haproxy -f /usr/local/etc/haproxy/haproxy.cfg
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
      - ceres-haproxy-logs:/var/log/haproxy
    ports:
      - "80:80"
      - "443:443"
      - "5432:5432"
      - "6379:6379"
      - "8404:8404"
    depends_on:
      - postgres-1
      - postgres-2
      - postgres-3
      - redis-1
      - redis-2
      - redis-3
    environment:
      - DOMAIN_NAME=${DOMAIN_NAME}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8404/stats"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ==================== Health Check Service ====================
  health-checker:
    image: alpine:latest
    container_name: ceres-health-checker
    networks:
      - core
      - apps
      - monitoring
    command: >
      sh -c "
      apk add --no-cache curl postgresql-client redis;
      while true; do
        echo '=== Health Check ===' $(date);
        
        # PostgreSQL HA Check
        for i in 1 2 3; do
          port=$((5431 + i));
          if pg_isready -h postgres-$i -p 5432 -U postgres -t 2 > /dev/null 2>&1; then
            echo ✓ PostgreSQL Node $i is healthy;
          else
            echo ✗ PostgreSQL Node $i is DOWN;
          fi;
        done;
        
        # Redis Sentinel Check
        for i in 1 2 3; do
          port=$((26378 + i));
          if redis-cli -h redis-sentinel-$i -p 26379 ping > /dev/null 2>&1; then
            echo ✓ Redis Sentinel $i is healthy;
          else
            echo ✗ Redis Sentinel $i is DOWN;
          fi;
        done;
        
        # HAProxy Stats
        if curl -s http://haproxy:8404/stats > /dev/null; then
          echo ✓ HAProxy is healthy;
        else
          echo ✗ HAProxy is DOWN;
        fi;
        
        sleep 60;
      done
      "
    depends_on:
      - postgres-1
      - postgres-2
      - postgres-3
      - redis-sentinel-1
      - redis-sentinel-2
      - redis-sentinel-3
      - haproxy
    restart: unless-stopped

volumes:
  ceres-etcd-data:
  ceres-postgres-1-data:
  ceres-postgres-2-data:
  ceres-postgres-3-data:
  ceres-redis-1-data:
  ceres-redis-2-data:
  ceres-redis-3-data:
  ceres-sentinel-1-data:
  ceres-sentinel-2-data:
  ceres-sentinel-3-data:
  ceres-haproxy-logs:

networks:
  core:
    driver: bridge
  apps:
    driver: bridge
  monitoring:
    driver: bridge
