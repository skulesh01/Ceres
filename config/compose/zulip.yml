version: '3.8'

services:
  zulip:
    image: zulip/docker-zulip:latest
    container_name: zulip
    hostname: zulip.ceres
    restart: unless-stopped
    environment:
      SETTING_EXTERNAL_HOST: zulip.ceres
      SETTING_ZULIP_ADMINISTRATOR: admin@ceres
      
      # PostgreSQL
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: zulip
      POSTGRES_USER: zulip
      POSTGRES_PASSWORD: ${ZULIP_DB_PASSWORD}
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      
      # Email (SMTP via Mailu)
      EMAIL_HOST: mail.ceres
      EMAIL_PORT: 587
      EMAIL_HOST_USER: zulip@ceres
      EMAIL_HOST_PASSWORD: ${ZULIP_SMTP_PASSWORD}
      EMAIL_USE_TLS: "True"
      DEFAULT_FROM_EMAIL: "Zulip <zulip@ceres>"
      NOREPLY_EMAIL_ADDRESS: noreply@ceres
      
      # OIDC (Keycloak)
      AUTHENTICATION_BACKENDS: zproject.backends.OIDCAuthBackend
      SOCIAL_AUTH_OIDC_ENABLED_IDPS: |
        {
          "keycloak": {
            "display_name": "Keycloak SSO",
            "oidc_url": "https://auth.ceres/realms/ceres",
            "client_id": "zulip",
            "secret": "${ZULIP_OIDC_SECRET}",
            "auto_signup": true
          }
        }
      
      # Secrets
      SECRETS_postgres_password: ${ZULIP_DB_PASSWORD}
      SECRETS_redis_password: ${REDIS_PASSWORD}
      SECRETS_secret_key: ${ZULIP_SECRET_KEY}
      
      # SSL
      SSL_CERTIFICATE_GENERATION: self-signed
    ports:
      - "8000:80"
      - "8443:443"
    volumes:
      - zulip_data:/data
    networks:
      - ceres_net
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  zulip_data:

networks:
  ceres_net:
    external: true
