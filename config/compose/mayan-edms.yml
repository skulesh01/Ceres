version: '3.8'

services:
  # Mayan EDMS Application
  mayan:
    image: mayanedms/mayanedms:latest
    container_name: mayan
    restart: unless-stopped
    environment:
      # Database
      MAYAN_DATABASE_ENGINE: postgresql
      MAYAN_DATABASE_NAME: mayan
      MAYAN_DATABASE_USER: mayan
      MAYAN_DATABASE_PASSWORD: ${MAYAN_DB_PASSWORD}
      MAYAN_DATABASE_HOST: postgres
      MAYAN_DATABASE_PORT: 5432
      
      # Redis & Celery
      MAYAN_REDIS_URL: redis://redis:6379/3
      MAYAN_CELERY_BROKER_URL: redis://redis:6379/3
      MAYAN_CELERY_RESULT_BACKEND: redis://redis:6379/3
      
      # OIDC (Keycloak)
      MAYAN_AUTHENTICATION_BACKENDS: mozilla_django_oidc.auth.OIDCAuthenticationBackend
      OIDC_RP_CLIENT_ID: mayan
      OIDC_RP_CLIENT_SECRET: ${MAYAN_OIDC_SECRET}
      OIDC_OP_AUTHORIZATION_ENDPOINT: https://auth.ceres/realms/ceres/protocol/openid-connect/auth
      OIDC_OP_TOKEN_ENDPOINT: https://auth.ceres/realms/ceres/protocol/openid-connect/token
      OIDC_OP_USER_ENDPOINT: https://auth.ceres/realms/ceres/protocol/openid-connect/userinfo
      OIDC_OP_JWKS_ENDPOINT: https://auth.ceres/realms/ceres/protocol/openid-connect/certs
      
      # Email
      MAYAN_EMAIL_BACKEND: django.core.mail.backends.smtp.EmailBackend
      MAYAN_EMAIL_HOST: mail.ceres
      MAYAN_EMAIL_PORT: 587
      MAYAN_EMAIL_USE_TLS: "True"
      MAYAN_EMAIL_HOST_USER: mayan@ceres
      MAYAN_EMAIL_HOST_PASSWORD: ${MAYAN_SMTP_PASSWORD}
      MAYAN_DEFAULT_FROM_EMAIL: mayan@ceres
      
      # OCR
      MAYAN_OCR_BACKEND: tesseract
      MAYAN_DOCUMENTS_LANGUAGE: eng,rus
      
      # Storage
      MAYAN_MEDIA_ROOT: /var/lib/mayan
      MAYAN_DOCUMENTS_STORAGE_BACKEND: django.core.files.storage.FileSystemStorage
    volumes:
      - mayan_data:/var/lib/mayan
      - mayan_media:/var/lib/mayan/document_storage
    networks:
      - ceres_net
    ports:
      - "8882:8000"
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # Mayan Celery Worker
  mayan-worker:
    image: mayanedms/mayanedms:latest
    container_name: mayan-worker
    restart: unless-stopped
    command: run_worker
    environment:
      MAYAN_DATABASE_ENGINE: postgresql
      MAYAN_DATABASE_NAME: mayan
      MAYAN_DATABASE_USER: mayan
      MAYAN_DATABASE_PASSWORD: ${MAYAN_DB_PASSWORD}
      MAYAN_DATABASE_HOST: postgres
      MAYAN_CELERY_BROKER_URL: redis://redis:6379/3
      MAYAN_CELERY_RESULT_BACKEND: redis://redis:6379/3
    volumes:
      - mayan_data:/var/lib/mayan
    networks:
      - ceres_net
    depends_on:
      - mayan
      - postgres
      - redis

  # Mayan Celery Beat (Scheduler)
  mayan-beat:
    image: mayanedms/mayanedms:latest
    container_name: mayan-beat
    restart: unless-stopped
    command: run_celery --settings=mayan.settings.production beat --loglevel=INFO
    environment:
      MAYAN_DATABASE_ENGINE: postgresql
      MAYAN_DATABASE_NAME: mayan
      MAYAN_DATABASE_USER: mayan
      MAYAN_DATABASE_PASSWORD: ${MAYAN_DB_PASSWORD}
      MAYAN_DATABASE_HOST: postgres
      MAYAN_CELERY_BROKER_URL: redis://redis:6379/3
    volumes:
      - mayan_data:/var/lib/mayan
    networks:
      - ceres_net
    depends_on:
      - mayan
      - postgres
      - redis

volumes:
  mayan_data:
  mayan_media:

networks:
  ceres_net:
    external: true
