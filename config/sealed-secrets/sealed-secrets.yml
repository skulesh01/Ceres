---
# Sealed Secrets for CERES K8s Secret Management
# Encrypts secrets in Git while keeping them synchronized
# Features: Per-cluster encryption, auto-rotation, backup integration
apiVersion: v1
kind: Namespace
metadata:
  name: sealed-secrets
  labels:
    app: sealed-secrets
---
# ServiceAccount for Sealed Secrets controller
apiVersion: v1
kind: ServiceAccount
metadata:
  name: sealed-secrets-controller
  namespace: sealed-secrets
---
# RBAC for Sealed Secrets
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: sealed-secrets-controller
  namespace: sealed-secrets
rules:
  - apiGroups:
      - bitnami.com
    resources:
      - sealedsecrets
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - bitnami.com
    resources:
      - sealedsecrets/status
    verbs:
      - update
  - apiGroups:
      - ""
    resources:
      - secrets
    verbs:
      - get
      - list
      - create
      - update
      - delete
      - watch
  - apiGroups:
      - ""
    resources:
      - events
    verbs:
      - create
      - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: sealed-secrets-controller
  namespace: sealed-secrets
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: sealed-secrets-controller
subjects:
  - kind: ServiceAccount
    name: sealed-secrets-controller
    namespace: sealed-secrets
---
# ClusterRole for Sealed Secrets
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: sealed-secrets-controller
rules:
  - apiGroups:
      - bitnami.com
    resources:
      - sealedsecrets
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - ""
    resources:
      - secrets
    verbs:
      - get
      - list
      - create
      - update
      - delete
  - apiGroups:
      - ""
    resources:
      - events
    verbs:
      - create
      - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: sealed-secrets-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: sealed-secrets-controller
subjects:
  - kind: ServiceAccount
    name: sealed-secrets-controller
    namespace: sealed-secrets
---
# ConfigMap with public sealing key (distribute to team)
apiVersion: v1
kind: ConfigMap
metadata:
  name: sealed-secrets-public-key
  namespace: sealed-secrets
data:
  tls.crt: |
    -----BEGIN CERTIFICATE-----
    MIIDXTCCAkWgAwIBAgIJAL0JHCcK3VxpMA0GCSqGSIb3DQEBCwUAMEUxCzAJBgNV
    BAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBX
    aWRnaXRzIFB0eSBMdGQwHhcNMjQwMTAxMDAwMDAwWhcNMzQwMTAxMDAwMDAwWjBF
    MQswCQYDVQQGEwJBVTETMBEGA1UECAwKU29tZS1TdGF0ZTEhMB8GA1UECgwYSW50
    ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB
    CgKCAQEA1234567890abcdefghijklmnopqrstuvwxyz...
    -----END CERTIFICATE-----
---
# Example SealedSecret for database credentials
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: postgres-credentials
  namespace: ceres
spec:
  encryptedData:
    password: AgBcD5F...encrypted-base64-data...
    username: AgBaB1C...encrypted-base64-data...
  template:
    metadata:
      name: postgres-credentials
      namespace: ceres
    type: Opaque
---
# Example SealedSecret for application secrets
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: ceres-app-secrets
  namespace: ceres
spec:
  encryptedData:
    jwt-secret: AgBcD5F...encrypted-base64-data...
    api-key: AgBaB1C...encrypted-base64-data...
    github-token: AgBaB1C...encrypted-base64-data...
    slack-webhook: AgBaB1C...encrypted-base64-data...
  template:
    metadata:
      name: ceres-app-secrets
      namespace: ceres
    type: Opaque
---
# Example SealedSecret for docker registry
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: docker-registry-credentials
  namespace: ceres
spec:
  encryptedData:
    .dockerconfigjson: AgBcD5F...encrypted-base64-data...
  template:
    metadata:
      name: docker-registry-credentials
      namespace: ceres
    type: kubernetes.io/dockercfg
---
# Secret for Sealed Secrets CA (highly sensitive - BACKUP OFFLINE!)
apiVersion: v1
kind: Secret
metadata:
  name: sealed-secrets-key
  namespace: sealed-secrets
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCi4uLmJhc2U2NCBlbmNvZGVkIGNlcnRpZmljYXRlLi4uCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQouLi5iYXNlNjQgZW5jb2RlZCBrZXkuLi4KLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0K
---
# Service for Sealed Secrets API
apiVersion: v1
kind: Service
metadata:
  name: sealed-secrets
  namespace: sealed-secrets
  labels:
    app: sealed-secrets
spec:
  ports:
    - port: 8080
      name: http
      targetPort: 8080
      protocol: TCP
  selector:
    app: sealed-secrets
  type: ClusterIP
---
# Deployment for Sealed Secrets Controller
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sealed-secrets-controller
  namespace: sealed-secrets
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sealed-secrets
  template:
    metadata:
      labels:
        app: sealed-secrets
    spec:
      serviceAccountName: sealed-secrets-controller
      containers:
        - name: sealed-secrets
          image: quay.io/bitnami/sealed-secrets-controller:v0.24.0
          imagePullPolicy: IfNotPresent
          command:
            - controller
          env:
            - name: SEALED_SECRETS_UPDATE_STATUS
              value: "true"
            - name: SEALED_SECRETS_ROTATION_ENABLED
              value: "false"  # Set to "true" for auto-rotation
          ports:
            - containerPort: 8080
              name: http
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
          volumeMounts:
            - name: keys
              mountPath: /etc/sealed-secrets-keys/
              readOnly: true
      volumes:
        - name: keys
          secret:
            secretName: sealed-secrets-key
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
---
# HPA for Sealed Secrets (if high load)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: sealed-secrets-controller
  namespace: sealed-secrets
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: sealed-secrets-controller
  minReplicas: 1
  maxReplicas: 3
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 80
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
