---
# CERES Database Operator - PostgreSQL Management & Automation
# v2.9.0 - Handles database provisioning, replication, failover, scaling
# Based on PostgreSQL Operator pattern with HA capabilities

apiVersion: v1
kind: ConfigMap
metadata:
  name: database-operator-config
  namespace: ceres
data:
  postgres-defaults.yaml: |
    postgresql:
      version: "15.2"
      maxConnections: 200
      sharedBuffers: "256MB"
      effectiveCacheSize: "1GB"
      maintenanceWorkMem: "64MB"
      checkpointCompletionTarget: 0.9
      walBuffers: "16MB"
      defaultStatisticsTarget: 100
      randomPageCost: 1.1
      effectiveIoConccurrency: 200
      synchronousCommit: "on"
      
    backup:
      enabled: true
      schedule: "0 2 * * *"
      retention: 30

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: database-operator
rules:
# CeresDatabase resource management
- apiGroups: ["ceres.io"]
  resources: ["ceresdatabases"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["ceres.io"]
  resources: ["ceresdatabases/status"]
  verbs: ["get", "update", "patch"]

# Pod and StatefulSet management
- apiGroups: [""]
  resources: ["pods", "pods/exec"]
  verbs: ["get", "list", "watch", "create", "delete"]
- apiGroups: ["apps"]
  resources: ["statefulsets", "statefulsets/status"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Service management
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# PVC and storage
- apiGroups: [""]
  resources: ["persistentvolumeclaims"]
  verbs: ["get", "list", "watch"]

# Secrets for credentials
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]

# ConfigMaps
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]

# Events
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: database-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: database-operator
subjects:
- kind: ServiceAccount
  name: database-operator
  namespace: ceres

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: database-operator
  namespace: ceres

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: database-operator
  namespace: ceres
  labels:
    app: database-operator
    version: v2.9.0
spec:
  replicas: 2
  selector:
    matchLabels:
      app: database-operator
  template:
    metadata:
      labels:
        app: database-operator
        version: v2.9.0
    spec:
      serviceAccountName: database-operator
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
      containers:
      - name: operator
        image: ceres-database-operator:2.9.0
        imagePullPolicy: IfNotPresent
        env:
        - name: OPERATOR_NAME
          value: "ceres-database-operator"
        - name: LOG_LEVEL
          value: "info"
        - name: METRICS_PORT
          value: "8080"
        - name: WATCH_NAMESPACE
          value: ""  # Watch all namespaces
        
        ports:
        - name: metrics
          containerPort: 8080
          protocol: TCP
        
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
        
        volumeMounts:
        - name: config
          mountPath: /etc/database-operator
          readOnly: true
      
      volumes:
      - name: config
        configMap:
          name: database-operator-config

---
# Example CeresDatabase resource - Production PostgreSQL Cluster
apiVersion: ceres.io/v1alpha1
kind: CeresDatabase
metadata:
  name: postgres-production
  namespace: ceres
spec:
  engine: postgresql
  version: "15.2"
  replicas: 3
  
  storage:
    size: 100Gi
    class: fast-ssd
  
  backup:
    enabled: true
    schedule: "0 2 * * *"  # Daily 2 AM
    retention: 30
  
  monitoring:
    enabled: true
  
  resources:
    requests:
      cpu: "1000m"
      memory: "2Gi"
    limits:
      cpu: "4000m"
      memory: "8Gi"

---
# Example CeresDatabase resource - Cache/Analytics Database
apiVersion: ceres.io/v1alpha1
kind: CeresDatabase
metadata:
  name: postgres-analytics
  namespace: ceres
spec:
  engine: postgresql
  version: "15.2"
  replicas: 2
  
  storage:
    size: 50Gi
    class: standard
  
  backup:
    enabled: true
    schedule: "0 4 * * 0"  # Weekly Sunday 4 AM
    retention: 7
  
  monitoring:
    enabled: true
  
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "2000m"
      memory: "4Gi"

---
# Service for primary database
apiVersion: v1
kind: Service
metadata:
  name: postgres-primary
  namespace: ceres
  labels:
    app: ceres
    database: postgres
spec:
  type: ClusterIP
  selector:
    app: postgres
    role: primary
  ports:
  - name: postgresql
    port: 5432
    targetPort: 5432
    protocol: TCP

---
# Service for read replicas
apiVersion: v1
kind: Service
metadata:
  name: postgres-replicas
  namespace: ceres
  labels:
    app: ceres
    database: postgres
spec:
  type: ClusterIP
  selector:
    app: postgres
    role: replica
  ports:
  - name: postgresql
    port: 5432
    targetPort: 5432
    protocol: TCP

---
# NetworkPolicy for database isolation
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-network-policy
  namespace: ceres
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: ceres
    - podSelector:
        matchLabels:
          app: backup-operator
    ports:
    - protocol: TCP
      port: 5432
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

---
# Pod Disruption Budget for HA
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: postgres-pdb
  namespace: ceres
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: postgres
      role: primary
