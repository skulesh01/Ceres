---
# CERES Backup Operator Deployment & Configuration
# v2.9.0 - Advanced backup management with Velero integration
# Handles backup scheduling, retention, verification, cross-cluster restore

apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-operator-config
  namespace: ceres
data:
  velero-config.yaml: |
    # Velero server configuration
    server:
      image: velero/velero:v1.12.0
      replicas: 1
      plugins:
      - velero-plugin-for-aws
      - velero-plugin-for-csi
    
    # Default backup storage location (S3)
    backupStorageLocation:
      provider: aws
      bucket: ceres-backups
      prefix: velero
      config:
        region: us-east-1
    
    # Default volume snapshot location
    volumeSnapshotLocation:
      provider: aws
      config:
        region: us-east-1
    
    # Backup schedules
    schedules:
      daily-full-backup:
        schedule: "0 2 * * *"  # Daily 2 AM UTC
        template:
          includedNamespaces: ["*"]
          excludedNamespaces: ["kube-system", "kube-node-lease"]
          storageLocation: default
          volumeSnapshotLocation: default
          ttl: "720h"  # Keep for 30 days
          hooks:
            resources:
            - name: db-pre-backup
              namespaces: ["ceres"]
              pre:
              - exec:
                  container: postgres
                  command: ["/bin/sh", "-c", "pg_dump -Fc > /tmp/backup.dump"]
      
      weekly-increment:
        schedule: "0 3 * * 1"  # Weekly Monday 3 AM UTC
        template:
          includedNamespaces: ["*"]
          itemOperationTimeout: "4h0m0s"
          ttl: "2160h"  # Keep for 90 days

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: backup-operator
rules:
# CereBackup resource management
- apiGroups: ["ceres.io"]
  resources: ["ceresbackups"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["ceres.io"]
  resources: ["ceresbackups/status"]
  verbs: ["get", "update", "patch"]

# Velero management
- apiGroups: ["velero.io"]
  resources: ["backups", "backupstoragelocations", "volumesnapshotlocations"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["velero.io"]
  resources: ["backups/status"]
  verbs: ["get", "update", "patch"]

# Cluster resource management
- apiGroups: [""]
  resources: ["pods", "namespaces", "secrets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["batch"]
  resources: ["jobs"]
  verbs: ["get", "list", "watch", "create"]

# Events and logs
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: backup-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: backup-operator
subjects:
- kind: ServiceAccount
  name: backup-operator
  namespace: ceres

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: backup-operator
  namespace: ceres

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backup-operator
  namespace: ceres
  labels:
    app: backup-operator
    version: v2.9.0
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: backup-operator
  template:
    metadata:
      labels:
        app: backup-operator
        version: v2.9.0
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: backup-operator
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
      - name: operator
        image: ceres-backup-operator:2.9.0
        imagePullPolicy: IfNotPresent
        command:
        - /app/backup-operator
        env:
        - name: VELERO_NAMESPACE
          value: "velero"
        - name: BACKUP_STORAGE_LOCATION
          value: "default"
        - name: CLEANUP_INTERVAL
          value: "1h"
        - name: VERIFICATION_ENABLED
          value: "true"
        - name: LOG_LEVEL
          value: "info"
        - name: METRICS_PORT
          value: "8080"
        
        # AWS credentials for S3
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: backup-credentials
              key: aws-access-key
              optional: true
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: backup-credentials
              key: aws-secret-key
              optional: true
        
        ports:
        - name: metrics
          containerPort: 8080
          protocol: TCP
        
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 2
        
        volumeMounts:
        - name: config
          mountPath: /etc/backup-operator
          readOnly: true
      
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - backup-operator
              topologyKey: kubernetes.io/hostname
      
      volumes:
      - name: config
        configMap:
          name: backup-operator-config

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: backup-operator
  namespace: ceres
  labels:
    app: backup-operator
spec:
  selector:
    matchLabels:
      app: backup-operator
  endpoints:
  - port: metrics
    interval: 30s
    scrapeTimeout: 10s

---
# Example CeresBackup resource
apiVersion: ceres.io/v1alpha1
kind: CeresBackup
metadata:
  name: daily-backup
  namespace: ceres
spec:
  type: full
  schedule: "0 2 * * *"  # Daily 2 AM
  destination:
    type: s3
    bucket: ceres-backups
    path: /daily
    credentials: backup-credentials
  
  retention:
    days: 30
    count: 20
  
  components:
  - database
  - cache
  - files
  
  encryption:
    enabled: true
    algorithm: AES-256-GCM
  
  verification:
    enabled: true
    schedule: "0 4 * * 0"  # Weekly Sunday 4 AM

---
# Incremental backup schedule
apiVersion: ceres.io/v1alpha1
kind: CeresBackup
metadata:
  name: hourly-backup
  namespace: ceres
spec:
  type: incremental
  schedule: "0 * * * *"  # Every hour
  destination:
    type: s3
    bucket: ceres-backups
    path: /hourly
    credentials: backup-credentials
  
  retention:
    days: 7
    count: 168
  
  components:
  - database
  - files
  
  encryption:
    enabled: true

---
# AWS credentials secret
apiVersion: v1
kind: Secret
metadata:
  name: backup-credentials
  namespace: ceres
type: Opaque
stringData:
  aws-access-key: "AKIA..."
  aws-secret-key: "..."
