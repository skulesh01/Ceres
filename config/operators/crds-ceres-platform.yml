---
# CERES Platform CRDs - Custom Resource Definitions
# v2.9.0 - Kubernetes Operators for automated management
# Defines: CeresPlatform, CeresTenant, CeresBackup, CeresDatabase

apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: ceresplatforms.ceres.io
  namespace: ceres
spec:
  group: ceres.io
  names:
    kind: CeresPlatform
    plural: ceresplatforms
    singular: ceresplatform
    shortNames:
    - cerespf
    - cpf
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            required:
            - version
            - infrastructure
            properties:
              # Platform version management
              version:
                type: string
                description: "CERES platform version (e.g., 2.9.0)"
                pattern: '^\d+\.\d+\.\d+$'
              
              # Infrastructure configuration
              infrastructure:
                type: object
                required:
                - cluster
                properties:
                  cluster:
                    type: string
                    enum: ["k3s", "eks", "aks", "gke"]
                    description: "Kubernetes cluster type"
                  
                  ingress:
                    type: object
                    properties:
                      class:
                        type: string
                        default: "nginx"
                      domain:
                        type: string
                        description: "Base domain (e.g., ceres.io)"
                      tlsIssuer:
                        type: string
                        default: "letsencrypt-prod"
                  
                  storage:
                    type: object
                    properties:
                      class:
                        type: string
                        default: "local-path"
                      size:
                        type: string
                        pattern: '^\d+Gi$'
                        default: "100Gi"
                  
                  monitoring:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                        default: true
                      prometheus:
                        type: object
                        properties:
                          retention:
                            type: string
                            default: "30d"
                          replicas:
                            type: integer
                            minimum: 1
                            maximum: 5
                            default: 2
              
              # Components configuration
              components:
                type: object
                properties:
                  core:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                        default: true
                      replicas:
                        type: integer
                        minimum: 1
                        maximum: 10
                        default: 3
                      resources:
                        type: object
                        properties:
                          requests:
                            type: object
                            properties:
                              cpu:
                                type: string
                                default: "500m"
                              memory:
                                type: string
                                default: "512Mi"
                          limits:
                            type: object
                            properties:
                              cpu:
                                type: string
                                default: "2000m"
                              memory:
                                type: string
                                default: "2Gi"
                  
                  database:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                        default: true
                      engine:
                        type: string
                        enum: ["postgresql", "mysql"]
                        default: "postgresql"
                      version:
                        type: string
                        default: "15.2"
                      persistence:
                        type: object
                        properties:
                          enabled:
                            type: boolean
                            default: true
                          size:
                            type: string
                            pattern: '^\d+Gi$'
                            default: "50Gi"
                  
                  cache:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                        default: true
                      engine:
                        type: string
                        enum: ["redis"]
                        default: "redis"
                      persistence:
                        type: object
                        properties:
                          size:
                            type: string
                            pattern: '^\d+Gi$'
                            default: "20Gi"
              
              # Multi-tenancy configuration
              multiTenancy:
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
                  maxTenants:
                    type: integer
                    minimum: 1
                    maximum: 1000
                    default: 100
                  isolation:
                    type: string
                    enum: ["database", "schema", "row-level"]
                    default: "row-level"
              
              # Security settings
              security:
                type: object
                properties:
                  tls:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                        default: true
                      minVersion:
                        type: string
                        default: "1.2"
                  rbac:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                        default: true
                  networkPolicy:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                        default: true
              
              # Backup & disaster recovery
              backup:
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
                  schedule:
                    type: string
                    default: "0 2 * * *"  # Daily at 2 AM
                  retention:
                    type: integer
                    minimum: 1
                    maximum: 365
                    default: 30
                  storage:
                    type: string
                    enum: ["s3", "gcs", "azure", "local"]
                    default: "s3"
          
          status:
            type: object
            properties:
              phase:
                type: string
                enum: ["Pending", "Creating", "Ready", "Updating", "Failed"]
                default: "Pending"
              lastUpdated:
                type: string
                format: date-time
              observedGeneration:
                type: integer
              conditions:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                    status:
                      type: string
                      enum: ["True", "False", "Unknown"]
                    reason:
                      type: string
                    message:
                      type: string
                    lastTransitionTime:
                      type: string
                      format: date-time

---
# CeresTenant CRD - для управления租户автопровижинга
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: cerestenants.ceres.io
  namespace: ceres
spec:
  group: ceres.io
  names:
    kind: CeresTenant
    plural: cerestenants
    singular: cerestenant
    shortNames:
    - tenant
    - tn
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            required:
            - tenantId
            - name
            - displayName
            properties:
              tenantId:
                type: string
                description: "Unique tenant identifier"
                pattern: '^[a-z0-9-]{3,32}$'
              
              name:
                type: string
                description: "Tenant name"
              
              displayName:
                type: string
                description: "Human-readable display name"
              
              description:
                type: string
                description: "Tenant description"
              
              plan:
                type: string
                enum: ["free", "starter", "professional", "enterprise"]
                default: "starter"
              
              namespace:
                type: string
                description: "Kubernetes namespace for tenant (auto-created if not exists)"
              
              admin:
                type: object
                required:
                - username
                - email
                properties:
                  username:
                    type: string
                  email:
                    type: string
                    format: email
                  firstName:
                    type: string
                  lastName:
                    type: string
              
              configuration:
                type: object
                properties:
                  logo:
                    type: string
                    description: "URL to tenant logo"
                  colors:
                    type: object
                    properties:
                      primary:
                        type: string
                        pattern: '^#[0-9A-Fa-f]{6}$'
                      secondary:
                        type: string
                        pattern: '^#[0-9A-Fa-f]{6}$'
                  features:
                    type: object
                    additionalProperties:
                      type: boolean
                  limits:
                    type: object
                    properties:
                      users:
                        type: integer
                      storage:
                        type: string
                      apiCalls:
                        type: integer
              
              quota:
                type: object
                properties:
                  cpu:
                    type: string
                    default: "4"
                  memory:
                    type: string
                    default: "8Gi"
                  storage:
                    type: string
                    default: "100Gi"
                  pods:
                    type: integer
                    default: 50
              
              billing:
                type: object
                properties:
                  billingEmail:
                    type: string
                    format: email
                  paymentMethod:
                    type: string
                    enum: ["credit-card", "invoice", "free"]
                  active:
                    type: boolean
                    default: true
              
              keycloak:
                type: object
                properties:
                  realmName:
                    type: string
                  createRealm:
                    type: boolean
                    default: true
              
              database:
                type: object
                properties:
                  separate:
                    type: boolean
                    default: false
                    description: "Create separate database per tenant"
                  backup:
                    type: boolean
                    default: true
          
          status:
            type: object
            properties:
              phase:
                type: string
                enum: ["Pending", "Provisioning", "Active", "Suspended", "Deleting"]
                default: "Pending"
              provisioned:
                type: string
                format: date-time
              lastUpdated:
                type: string
                format: date-time
              namespace:
                type: string
              keycloakRealm:
                type: string
              database:
                type: object
                properties:
                  host:
                    type: string
                  port:
                    type: integer
                  name:
                    type: string
              conditions:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                    status:
                      type: string
                      enum: ["True", "False", "Unknown"]
                    reason:
                      type: string
                    message:
                      type: string

---
# CeresBackup CRD - для управления резервными копиями
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: ceresbackups.ceres.io
  namespace: ceres
spec:
  group: ceres.io
  names:
    kind: CeresBackup
    plural: ceresbackups
    singular: ceresbackup
    shortNames:
    - backup
    - bk
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            required:
            - type
            - destination
            properties:
              type:
                type: string
                enum: ["full", "incremental", "differential", "snapshot"]
                description: "Backup type"
              
              destination:
                type: object
                required:
                - type
                properties:
                  type:
                    type: string
                    enum: ["s3", "gcs", "azure-blob", "local"]
                  bucket:
                    type: string
                  path:
                    type: string
                    default: "/backups"
                  credentials:
                    type: string
                    description: "Secret name with credentials"
              
              schedule:
                type: string
                description: "Cron schedule for automatic backups"
              
              retention:
                type: object
                properties:
                  days:
                    type: integer
                    default: 30
                  count:
                    type: integer
                    description: "Keep last N backups"
              
              components:
                type: array
                items:
                  type: string
                  enum: ["database", "cache", "files", "etcd"]
                default: ["database", "files"]
              
              encryption:
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
                  algorithm:
                    type: string
                    default: "AES-256-GCM"
              
              verification:
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
                  schedule:
                    type: string
                    description: "When to verify backup integrity"
          
          status:
            type: object
            properties:
              phase:
                type: string
                enum: ["Pending", "Running", "Succeeded", "Failed", "Verified"]
              startTime:
                type: string
                format: date-time
              completionTime:
                type: string
                format: date-time
              size:
                type: string
              location:
                type: string
              checksum:
                type: string
              error:
                type: string

---
# CeresDatabase CRD - для управления базами данных
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: ceresdatabases.ceres.io
  namespace: ceres
spec:
  group: ceres.io
  names:
    kind: CeresDatabase
    plural: ceresdatabases
    singular: ceresdatabase
    shortNames:
    - database
    - db
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            required:
            - engine
            - version
            properties:
              engine:
                type: string
                enum: ["postgresql", "mysql", "mongodb"]
              
              version:
                type: string
                description: "Database engine version"
              
              replicas:
                type: integer
                minimum: 1
                maximum: 10
                default: 3
              
              storage:
                type: object
                properties:
                  size:
                    type: string
                    pattern: '^\d+Gi$'
                    default: "50Gi"
                  class:
                    type: string
                    default: "standard"
              
              backup:
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
                  schedule:
                    type: string
                    default: "0 2 * * *"
                  retention:
                    type: integer
                    default: 30
              
              monitoring:
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
              
              resources:
                type: object
                properties:
                  requests:
                    type: object
                    properties:
                      cpu:
                        type: string
                        default: "1000m"
                      memory:
                        type: string
                        default: "2Gi"
                  limits:
                    type: object
                    properties:
                      cpu:
                        type: string
                        default: "4000m"
                      memory:
                        type: string
                        default: "8Gi"
          
          status:
            type: object
            properties:
              phase:
                type: string
                enum: ["Pending", "Creating", "Ready", "Failed"]
              serviceName:
                type: string
              port:
                type: integer
              username:
                type: string
              passwordSecret:
                type: string
              lastBackup:
                type: string
                format: date-time
              replicationLag:
                type: string
