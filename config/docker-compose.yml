services:
  # -------------------------------------------------
  # 1️⃣ Traefik – reverse proxy & TLS (auto Let's Encrypt)
  # -------------------------------------------------
  traefik:
    image: traefik:v3.0
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.myresolver.acme.email=admin@${DOMAIN}"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "traefik_letsencrypt:/letsencrypt"
    networks:
      - internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.api.service=api@internal"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=myresolver"

  # -------------------------------------------------
  # 2️⃣ PostgreSQL – shared DB for most services
  # -------------------------------------------------
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      POSTGRES_DB: "company"
    volumes:
      - "pg_data:/var/lib/postgresql/data"
    networks:
      - internal

  # -------------------------------------------------
  # 3️⃣ Redis – cache / broker
  # -------------------------------------------------
  redis:
    image: redis:7-alpine
    networks:
      - internal

  # -------------------------------------------------
  # 4️⃣ Keycloak – SSO / OIDC provider
  # -------------------------------------------------
  keycloak:
    image: quay.io/keycloak/keycloak:24.0.1
    command: [ "start-dev" ]
    environment:
      KEYCLOAK_ADMIN: "${KEYCLOAK_ADMIN}"
      KEYCLOAK_ADMIN_PASSWORD: "${KEYCLOAK_ADMIN_PASSWORD}"
      KC_DB: "postgres"
      KC_DB_URL_HOST: "postgres"
      KC_DB_URL_DATABASE: "company"
      KC_DB_USERNAME: "postgres"
      KC_DB_PASSWORD: "${POSTGRES_PASSWORD}"

    depends_on:
      - postgres
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.keycloak.rule=Host(`auth.${DOMAIN}`)"
      - "traefik.http.routers.keycloak.entrypoints=websecure"
      - "traefik.http.routers.keycloak.tls.certresolver=myresolver"
    networks:
      - internal

  # -------------------------------------------------
  # 5️⃣ Nextcloud – file storage (WebDAV)
  # -------------------------------------------------
  nextcloud:
    image: nextcloud:30-apache
    environment:
      POSTGRES_HOST: "postgres"
      POSTGRES_DB: "company"
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
    depends_on:
      - postgres
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.rule=Host(`cloud.${DOMAIN}`)"
      - "traefik.http.routers.nextcloud.entrypoints=websecure"
      - "traefik.http.routers.nextcloud.tls.certresolver=myresolver"
    volumes:
      - "nextcloud_data:/var/www/html"
    networks:
      - internal

  # -------------------------------------------------
  # 6️⃣ ProcessMaker – EDM & workflow (OIDC + WebDAV)
  # -------------------------------------------------
  processmaker:
    image: processmaker/processmaker:5.4.0
    environment:
      DB_HOST: "postgres"
      DB_PORT: "5432"
      DB_DATABASE: "company"
      DB_USERNAME: "postgres"
      DB_PASSWORD: "${POSTGRES_PASSWORD}"
      OIDC_ISSUER: "https://auth.${DOMAIN}/realms/company"
      OIDC_CLIENT_ID: "processmaker"
      OIDC_CLIENT_SECRET: "${KEYCLOAK_CLIENT_SECRET_PM}"
      NEXTCLOUD_URL: "https://cloud.${DOMAIN}/remote.php/dav/files"
      NEXTCLOUD_TOKEN: "${NEXTCLOUD_TOKEN}"
    depends_on:
      - postgres
      - keycloak
      - nextcloud
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.processmaker.rule=Host(`edm.${DOMAIN}`)"
      - "traefik.http.routers.processmaker.entrypoints=websecure"
      - "traefik.http.routers.processmaker.tls.certresolver=myresolver"
    networks:
      - internal

  # -------------------------------------------------
  # 7️⃣ Taiga backend – with LDAP, Slack, Time‑Tracking plugins
  # -------------------------------------------------
  taiga-back:
    build:
      context: ./taiga/backend
    environment:
      POSTGRES_HOST: "postgres"
      POSTGRES_DB: "company"
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      LDAP_URL: "ldap://freeipa.${DOMAIN}"
      LDAP_BIND_DN: "uid=admin,cn=users,cn=accounts,dc=company,dc=local"
      LDAP_BIND_PASSWORD: "${FREEIPA_ADMIN_PASSWORD}"
      SLACK_WEBHOOK_URL: "${SLACK_WEBHOOK_URL}"
    depends_on:
      - postgres
      - freeipa
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.taiga-back.rule=Host(`taiga.${DOMAIN}`)"
      - "traefik.http.routers.taiga-back.entrypoints=websecure"
      - "traefik.http.routers.taiga-back.tls.certresolver=myresolver"
    networks:
      - internal

  # -------------------------------------------------
  # 8️⃣ Taiga front – Angular UI (with optional Gantt plugin)
  # -------------------------------------------------
  taiga-front:
    build:
      context: ./taiga/front
    environment:
      API_URL: "https://taiga.${DOMAIN}/api/v1/"
    depends_on:
      - taiga-back
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.taiga-front.rule=Host(`taiga.${DOMAIN}`)"
      - "traefik.http.routers.taiga-front.entrypoints=websecure"
      - "traefik.http.routers.taiga-front.tls.certresolver=myresolver"
    networks:
      - internal

  # -------------------------------------------------
  # 9️⃣ Gitea – Git server + CI
  # -------------------------------------------------
  gitea:
    image: gitea/gitea:1.22
    environment:
      DB_TYPE: postgres
      DB_HOST: postgres:5432
      DB_NAME: company
      DB_USER: postgres
      DB_PASSWD: "${POSTGRES_PASSWORD}"
    volumes:
      - "gitea_data:/data"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitea.rule=Host(`git.${DOMAIN}`)"
      - "traefik.http.routers.gitea.entrypoints=websecure"
      - "traefik.http.routers.gitea.tls.certresolver=myresolver"
    depends_on:
      - postgres
    networks:
      - internal

  # -------------------------------------------------
  # 10️⃣ Mailcow – SMTP/IMAP
  # -------------------------------------------------
  mailcow:
    image: mailcow/mailcow:latest
    environment:
      DBHOST: "postgres"
      DBNAME: "company"
      DBUSER: "postgres"
      DBPASS: "${POSTGRES_PASSWORD}"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mailcow.rule=Host(`mail.${DOMAIN}`)"
      - "traefik.http.routers.mailcow.entrypoints=websecure"
      - "traefik.http.routers.mailcow.tls.certresolver=myresolver"
    depends_on:
      - postgres
    networks:
      - internal

  # -------------------------------------------------
  # 11️⃣ ERPNext – accounting & invoicing
  # -------------------------------------------------
  erpnext:
    image: frappe/erpnext:version-15
    environment:
      MYSQL_ROOT_PASSWORD: "${POSTGRES_PASSWORD}"
      SITE_NAME: "erp.${DOMAIN}"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.erpnext.rule=Host(`erp.${DOMAIN}`)"
      - "traefik.http.routers.erpnext.entrypoints=websecure"
      - "traefik.http.routers.erpnext.tls.certresolver=myresolver"
    networks:
      - internal

  # -------------------------------------------------
  # 12️⃣ SuiteCRM – CRM
  # -------------------------------------------------
  suitecrm:
    image: suitecrm/suitecrm:8.1
    environment:
      DB_HOST: "postgres"
      DB_NAME: "company"
      DB_USER: "postgres"
      DB_PASSWORD: "${POSTGRES_PASSWORD}"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.suitecrm.rule=Host(`crm.${DOMAIN}`)"
      - "traefik.http.routers.suitecrm.entrypoints=websecure"
      - "traefik.http.routers.suitecrm.tls.certresolver=myresolver"
    depends_on:
      - postgres
    networks:
      - internal

  # -------------------------------------------------
  # 13️⃣ MeshCentral – remote RDP/SSH
  # -------------------------------------------------
  meshcentral:
    image: meshcentral/meshcentral:latest
    environment:
      MESHcentral_ADMIN: "admin@${DOMAIN}"
      MESHcentral_ADMIN_PASSWORD: "${MESHADMIN_PASSWORD}"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.meshcentral.rule=Host(`remote.${DOMAIN}`)"
      - "traefik.http.routers.meshcentral.entrypoints=websecure"
      - "traefik.http.routers.meshcentral.tls.certresolver=myresolver"
    networks:
      - internal

  # -------------------------------------------------
  # 14️⃣ FreeIPA – LDAP / AD‑like directory
  # -------------------------------------------------
  freeipa:
    image: freeipa/freeipa-server:centos-8
    environment:
      IPA_SERVER_HOSTNAME: "freeipa.${DOMAIN}"
      IPA_SERVER_IP: "${FREEIPA_IP}"
      IPA_ADMIN_PASSWORD: "${FREEIPA_ADMIN_PASSWORD}"
    ports:
      - "389:389"
      - "636:636"
    volumes:
      - "freeipa_data:/data"
    networks:
      - internal

  # -------------------------------------------------
  # 15️⃣ Proxmox‑API – thin proxy to Proxmox VE (optional)
  # -------------------------------------------------
  proxmox-api:
    image: alpine/socat
    command: [ "tcp-listen:8006,reuseaddr,fork", "tcp-connect:proxmox:8006" ]
    # depends_on:
    #   - proxmox
    networks:
      - internal

  # -------------------------------------------------
  # 16️⃣ Prometheus – metrics collection
  # -------------------------------------------------
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - "./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.${DOMAIN}`)"
      - "traefik.http.routers.prometheus.entrypoints=websecure"
      - "traefik.http.routers.prometheus.tls.certresolver=myresolver"
    networks:
      - internal

  # -------------------------------------------------
  # 17️⃣ Grafana – dashboards
  # -------------------------------------------------
  grafana:
    image: grafana/grafana:10.2.0
    depends_on:
      - prometheus
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.${DOMAIN}`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls.certresolver=myresolver"
    networks:
      - internal

  # -------------------------------------------------
  # 18️⃣ Loki – log aggregation
  # -------------------------------------------------
  loki:
    image: grafana/loki:2.9.2
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - "loki_data:/loki"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.loki.rule=Host(`loki.${DOMAIN}`)"
      - "traefik.http.routers.loki.entrypoints=websecure"
      - "traefik.http.routers.loki.tls.certresolver=myresolver"
    networks:
      - internal

  # -------------------------------------------------
  # 19️⃣ Netdata – real‑time server metrics
  # -------------------------------------------------
  netdata:
    image: netdata/netdata:latest
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    ports:
      - "19999:19999"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.netdata.rule=Host(`netdata.${DOMAIN}`)"
      - "traefik.http.routers.netdata.entrypoints=websecure"
      - "traefik.http.routers.netdata.tls.certresolver=myresolver"
    networks:
      - internal

  # -------------------------------------------------
  # 20️⃣ Restic – scheduled backups to MinIO (S3‑compatible)
  # -------------------------------------------------
  restic:
    image: restic/restic:latest
    environment:
      RESTIC_REPOSITORY: "s3:https://minio.${DOMAIN}/backups"
      RESTIC_PASSWORD: "${RESTIC_PASSWORD}"
      AWS_ACCESS_KEY_ID: "${MINIO_ACCESS_KEY}"
      AWS_SECRET_ACCESS_KEY: "${MINIO_SECRET_KEY}"
    volumes:
      - "pg_data:/var/lib/postgresql/data"
      - "nextcloud_data:/nextcloud"
      - "gitea_data:/gitea"
    command: [ "backup", "--verbose", "--tag", "daily" ]
    networks:
      - internal

  # -------------------------------------------------
  # 21️⃣ MinIO – S3‑compatible object storage (for backups & docs)
  # -------------------------------------------------
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: "${MINIO_ACCESS_KEY}"
      MINIO_ROOT_PASSWORD: "${MINIO_SECRET_KEY}"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - "minio_data:/data"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio.rule=Host(`minio.${DOMAIN}`)"
      - "traefik.http.routers.minio.entrypoints=websecure"
      - "traefik.http.routers.minio.tls.certresolver=myresolver"
    networks:
      - internal

volumes:
  pg_data:
  redis_data:
  traefik_letsencrypt:
  nextcloud_data:
  gitea_data:
  freeipa_data:
  minio_data:
  loki_data:
    # add other volumes as needed

networks:
  internal:
    driver: bridge
