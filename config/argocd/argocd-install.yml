---
# ArgoCD Installation and Configuration for CERES v2.8.0
# Provides declarative Kubernetes deployment and continuous synchronization
# Features: ApplicationSet, multi-cluster, image auto-updates, notifications
apiVersion: v1
kind: Namespace
metadata:
  name: argocd
  labels:
    app: argocd
---
# ArgoCD Server ConfigMap for customization
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cmd-params-cm
  namespace: argocd
data:
  # Enable Dex for SSO integration
  dex.openshift.url: https://argocd.ceres.local/dex
  # ArgoCD server settings
  server.insecure: "false"
  server.basehref: /
  server.rootpath: ""
  # Redis optimization for large environments
  redis.server: redis.argocd.svc.cluster.local:6379
  # Disable TLS cert verification for self-signed certs (production: use proper certs)
  server.disable.auth: "false"
---
# ArgoCD RBAC ConfigMap for multi-tenant access control
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
data:
  policy.default: 'role:readonly'
  policy.csv: |
    # Grant admin role to cluster admins
    p, role:admin, applications, *, */*, allow
    p, role:admin, repositories, *, *, allow
    p, role:admin, clusters, *, *, allow
    p, role:admin, accounts, *, *, allow
    p, role:admin, gpgkeys, *, *, allow
    
    # Grant developer role for tenant applications
    p, role:developer, applications, get, ceres/*, allow
    p, role:developer, applications, sync, ceres/*, allow
    p, role:developer, repositories, get, *, allow
    p, role:developer, logs, get, ceres/*, allow
    
    # Grant viewer role for read-only access
    p, role:viewer, applications, get, */*, allow
    p, role:viewer, repositories, get, *, allow
    p, role:viewer, logs, get, */*, allow
    
    # Grant tenant-specific admins access to their apps only
    p, role:tenant-admin, applications, *, ceres/tenant-*, allow
    p, role:tenant-admin, applications, sync, ceres/tenant-*, allow
    
    # Tenant definitions (map users to roles)
    g, admin-user, role:admin
    g, developer-user, role:developer
    g, viewer-user, role:viewer
    g, tenant-acme-admin, role:tenant-admin
  scopes: '[groups]'
---
# ArgoCD Notifications ConfigMap for Slack/Teams/Email notifications
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  service.slack: |
    token: $slack-token
  service.teams: |
    webhookUrl: $teams-webhook-url
  template.app-health-degraded: |
    message: |
      Application {{.app.metadata.name}} health is degraded.
      {{if eq .app.status.operationState.phase "Error"}}
        Sync is failed with error: {{.app.status.operationState.message}}
      {{end}}
    teams:
      attachments: |
        [{
          "color": "#ff9900",
          "sections": [{
            "activityTitle": "{{ .app.metadata.name}}",
            "facts": [
              {"name": "Sync Status", "value": "{{ .app.status.sync.status}}"},
              {"name": "Health Status", "value": "{{ .app.status.health.status}}"}
            ]
          }]
        }]
  template.app-deployed: |
    message: |
      Application {{.app.metadata.name}} is now running on {{.app.status.operationState.finishedAt}}.
      {{if eq .serviceType "slack"}}:white_check_mark:{{end}} {{if eq .serviceType "teams"}}âœ“{{end}}
  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [app-health-degraded]
  trigger.on-sync-failed: |
    - when: app.status.operationState.phase in ['Error', 'Failed']
      send: [app-health-degraded]
  trigger.on-sync-succeeded: |
    - when: app.status.operationState.phase in ['Succeeded'] and app.status.operationState.finishedAt != ''
      send: [app-deployed]
---
# ArgoCD Helm Values ConfigMap (alternative to values-argocd.yml)
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-helm-values-cm
  namespace: argocd
data:
  values.yaml: |
    server:
      autoscaling:
        enabled: true
        minReplicas: 2
        maxReplicas: 4
      service:
        type: LoadBalancer
        annotations:
          service.beta.kubernetes.io/aws-load-balancer-type: nlb
      ingress:
        enabled: true
        ingressClassName: nginx
        hosts:
          - argocd.ceres.local
        tls:
          - secretName: argocd-tls
            hosts:
              - argocd.ceres.local
      config:
        oidc.config: |
          name: Keycloak
          issuer: https://keycloak.ceres.local/realms/master
          clientID: argocd-client
          clientSecret: $argocd-client-secret
          requestedScopes:
            - openid
            - profile
            - email
            - groups
    
    repo:
      autoscaling:
        enabled: true
        minReplicas: 2
    
    redis:
      enabled: true
      auth:
        enabled: true
      master:
        persistence:
          enabled: true
          size: 10Gi
    
    controller:
      replicas: 2
    
    applicationSet:
      enabled: true
      replicas: 2
    
    notifications:
      enabled: true
      argocdUrl: https://argocd.ceres.local
---
# Secret for ArgoCD Repository SSH Key
apiVersion: v1
kind: Secret
metadata:
  name: argocd-repo-ssh-key
  namespace: argocd
  labels:
    argocd.argoproj.io/secret-type: repository
type: Opaque
data:
  # Base64 encoded private SSH key for GitHub/GitLab access
  sshPrivateKey: LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KVGhpcyBpcyBhIHBsYWNlaG9sZGVyIC0gcmVwbGFjZSB3aXRoIGFjdHVhbCBrZXkKLS0tLS1FTkQgT1BFTlNTSCBQUklWQVRFIEtFWS0tLS0tCg==
---
# Secret for ArgoCD OIDC/GitHub OAuth
apiVersion: v1
kind: Secret
metadata:
  name: argocd-secret
  namespace: argocd
type: Opaque
stringData:
  # Admin password hash (bcrypt)
  admin.password: $2a$10$rRyq8Q8T8H8T8H8T8H8T8H8T8H8T8H8T8H8T8H8T8H8T8H8T8H8T8
  admin.passwordMtime: '2024-01-01T00:00:00Z'
  # GitHub OAuth token for automatic repo access
  github-creds: $github-token
  # Slack token for notifications
  slack-token: $slack-token
  # Teams webhook for notifications
  teams-webhook-url: $teams-webhook
  # ArgoCD Client Secret for OIDC
  argocd-client-secret: $argocd-oidc-secret
---
# ArgoCD Application Controller ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-application-controller
  namespace: argocd
---
# RBAC for ArgoCD Controller
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: argocd-application-controller
rules:
  - apiGroups: ["*"]
    resources: ["*"]
    verbs: ["*"]
  - nonResourceURLs: ["*"]
    verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: argocd-application-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argocd-application-controller
subjects:
  - kind: ServiceAccount
    name: argocd-application-controller
    namespace: argocd
---
# ArgoCD Server ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-server
  namespace: argocd
---
# RBAC for ArgoCD Server
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: argocd-server
rules:
  - apiGroups: ["*"]
    resources: ["*"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["*"]
    resources: ["*"]
    verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: argocd-server
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argocd-server
subjects:
  - kind: ServiceAccount
    name: argocd-server
    namespace: argocd
---
# Project Template for CERES Applications
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: ceres-project
  namespace: argocd
spec:
  sourceRepos:
    - 'https://github.com/ceres-platform/*'
    - 'https://github.com/org/*'
  destinations:
    - namespace: 'ceres'
      server: https://kubernetes.default.svc
    - namespace: 'monitoring'
      server: https://kubernetes.default.svc
    - namespace: 'tenants'
      server: https://kubernetes.default.svc
    - namespace: 'ceres-*'  # Multi-tenant namespaces
      server: https://kubernetes.default.svc
  clusterResourceWhitelist:
    - group: ''
      kind: Namespace
    - group: 'rbac.authorization.k8s.io'
      kind: ClusterRole
    - group: 'rbac.authorization.k8s.io'
      kind: ClusterRoleBinding
  namespaceResourceBlacklist:
    - group: ''
      kind: ResourceQuota
    - group: ''
      kind: LimitRange
    - group: ''
      kind: NetworkPolicy
  # Sync policy
  syncWindows:
    - kind: allow
      schedule: '0 2 * * *'  # Allow sync at 2 AM
      duration: 1h
---
# Secret for External Clusters (for multi-cluster setup)
apiVersion: v1
kind: Secret
metadata:
  name: argocd-cluster-secret
  namespace: argocd
  labels:
    argocd.argoproj.io/secret-type: cluster
type: Opaque
stringData:
  name: external-cluster
  server: https://external-cluster.example.com:6443
  config: |
    {
      "bearerToken": "eyJhbGciOiJSUzI1NiIsImtpZCI6IjEyMyJ9...",
      "tlsClientConfig": {
        "caData": "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJWekNDQVFtZ0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRc0ZBREFTTVJRd0VnWURWUVFERXd0dmIyTnkKYjI5dmN6QXVZM1l4SWhnQkIyeGhjMmxqTFhObGNuWmxjaTlzYjJOaGJHaHZjM1F4QmdOVkhSQUZCZ3dCZ1lEClZSMFNBREFUQmdOVkhRMExEQXNCZ05WU0FJQkF3Y0NBMEFNQVlHQ0NxR1NNNDlCQU1DQkFnTkZCQU1DQmdOVgpIUjhFUXpCaFRFRmZSVlJ6YVc1bmMzSmhhMlY1TFV4aGRHWlBjMjFoYkhWbElWUm9aWEp3YjIxaGEySXNJRlJ5CmRYTkJUMFpRSURRNE5qazBOakl3TWpBME16az0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
      }
    }
