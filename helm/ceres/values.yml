# Helm Values для CERES Kubernetes deployment
# Используется: helm install ceres ./helm/ceres -f helm/ceres/values.yml

global:
  domain: ceres.local
  imagePullPolicy: IfNotPresent
  storageClass: ceres-database
  replicas:
    production: 3
    staging: 2
    development: 1

# PostgreSQL - Database backend
postgresql:
  enabled: true
  primary:
    replicas: 3
    persistence:
      enabled: true
      size: 100Gi
      storageClass: ceres-database
    resources:
      requests:
        cpu: 2
        memory: 4Gi
      limits:
        cpu: 4
        memory: 8Gi
  auth:
    username: ceres_user
    existingSecret: postgres-credentials
    secretKeys:
      adminPasswordKey: postgres-password
      userPasswordKey: password
  primary:
    initdb:
      scripts:
        init.sql: |
          CREATE DATABASE ceres_db;
          CREATE DATABASE nextcloud_db;
          CREATE DATABASE gitea_db;
          CREATE DATABASE mattermost_db;
          CREATE DATABASE redmine_db;
          CREATE DATABASE wikijs_db;
          -- Apply RLS policies
          \c ceres_db
          \i /docker-entrypoint-initdb.d/10-rls.sql
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

# Redis - Cache and session store
redis:
  enabled: true
  replica:
    replicaCount: 3
  master:
    persistence:
      enabled: true
      size: 50Gi
      storageClass: ceres-cache
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1
      memory: 2Gi
  auth:
    enabled: true
    existingSecret: redis-credentials
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

# Keycloak - Identity and Access Management
keycloak:
  enabled: true
  replicas: 3
  image:
    repository: quay.io/keycloak/keycloak
    tag: "24.0.0"
  auth:
    adminUser: admin
    existingSecret: keycloak-credentials
  postgresql:
    enabled: false  # Используем главную БД
    host: postgres
    port: 5432
    username: keycloak_user
    existingSecret: postgres-credentials
  cache:
    enabled: true
    host: redis
    port: 6379
  ingress:
    enabled: true
    ingressClassName: nginx
    hosts:
      - keycloak.ceres.local
    tls:
      enabled: true
      secretName: keycloak-tls
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1
      memory: 2Gi
  serviceMonitor:
    enabled: true

# Ingress Nginx Controller
ingress:
  enabled: true
  className: nginx
  controller:
    replicaCount: 3
    service:
      type: NodePort
      externalTrafficPolicy: Local
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    config:
      use-forwarded-headers: "true"
      real-ip-header: "X-Forwarded-For"
      enable-modsecurity: "true"
      enable-owasp-core-rules: "true"
      ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256"
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "10254"
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true

# Nextcloud - File sharing
nextcloud:
  enabled: true
  image:
    repository: nextcloud
    tag: "28-fpm-alpine"
  replicas: 3
  persistence:
    enabled: true
    size: 200Gi
    storageClass: ceres-database
  ingress:
    enabled: true
    className: nginx
    hosts:
      - nextcloud.ceres.local
    tls:
      enabled: true
      secretName: nextcloud-tls
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 1
      memory: 1Gi

# Gitea - Git service
gitea:
  enabled: true
  image:
    repository: gitea/gitea
    tag: "1.21-alpine"
  replicas: 2
  persistence:
    enabled: true
    size: 100Gi
    storageClass: ceres-database
  ingress:
    enabled: true
    className: nginx
    hosts:
      - gitea.ceres.local
      - git.ceres.local
    tls:
      enabled: true
      secretName: gitea-tls
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 1
      memory: 1Gi

# Mattermost - Team collaboration
mattermost:
  enabled: true
  image:
    repository: mattermost/mattermost-team-edition
    tag: "9.2"
  replicas: 3
  persistence:
    enabled: true
    size: 50Gi
    storageClass: ceres-database
  ingress:
    enabled: true
    className: nginx
    hosts:
      - mattermost.ceres.local
      - chat.ceres.local
    tls:
      enabled: true
      secretName: mattermost-tls
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1
      memory: 2Gi

# Redmine - Project management
redmine:
  enabled: true
  image:
    repository: redmine
    tag: "5.0-alpine"
  replicas: 2
  persistence:
    enabled: true
    size: 50Gi
  ingress:
    enabled: true
    className: nginx
    hosts:
      - redmine.ceres.local
      - projects.ceres.local
    tls:
      enabled: true
      secretName: redmine-tls
  resources:
    requests:
      cpu: 300m
      memory: 512Mi
    limits:
      cpu: 600m
      memory: 1Gi

# Wiki.js - Knowledge base
wikijs:
  enabled: true
  image:
    repository: requarks/wiki
    tag: "2.5"
  replicas: 2
  persistence:
    enabled: true
    size: 50Gi
  ingress:
    enabled: true
    className: nginx
    hosts:
      - wiki.ceres.local
      - docs.ceres.local
    tls:
      enabled: true
      secretName: wikijs-tls
  resources:
    requests:
      cpu: 300m
      memory: 512Mi
    limits:
      cpu: 600m
      memory: 1Gi

# Prometheus - Monitoring
prometheus:
  enabled: true
  replicas: 3
  persistentVolume:
    enabled: true
    size: 100Gi
    storageClass: ceres-database
  retention: 30d
  resources:
    requests:
      cpu: 500m
      memory: 2Gi
    limits:
      cpu: 1
      memory: 4Gi
  ingress:
    enabled: true
    ingressClassName: nginx
    hosts:
      - prometheus.ceres.local
    tls:
      enabled: true

# Loki - Log aggregation
loki:
  enabled: true
  persistence:
    enabled: true
    size: 50Gi
    storageClass: ceres-database
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1
      memory: 2Gi
  loki:
    auth_enabled: true
    limits_config:
      retention_period: 7d
  ingress:
    enabled: true
    ingressClassName: nginx
    hosts:
      - loki.ceres.local

# Pod Security Standards
podSecurityStandards:
  enforce: restricted
  audit: restricted
  warn: restricted

# Network Policies для multi-tenancy
networkPolicies:
  enabled: true
  tenantIsolation:
    enabled: true
    ingressFromNginx: true
    egressToDB: true
    egressToKubeDNS: true

# RBAC Configuration
rbac:
  create: true
  serviceAccountName: ceres

# Multi-tenancy настройки
multiTenancy:
  enabled: true
  namespacePerTenant: true
  defaultQuota:
    pods: "100"
    requests:
      cpu: "10"
      memory: "20Gi"
    limits:
      cpu: "20"
      memory: "40Gi"

# Resource defaults
resources:
  default:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
