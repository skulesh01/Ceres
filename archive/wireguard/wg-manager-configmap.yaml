---
apiVersion: v1
kind: ConfigMap
metadata:
  name: wg-manager-code
  namespace: ceres
data:
  wg-config-manager.py: |
    """
    WireGuard Config Manager - автоматизированное управление конфигами и почтой
    """
    
    import os
    import json
    import base64
    import smtplib
    import requests
    import logging
    import subprocess
    from datetime import datetime
    from pathlib import Path
    from email.mime.text import MIMEText
    from email.mime.multipart import MIMEMultipart
    from flask import Flask, request, jsonify
    from functools import wraps
    import time
    
    logging.basicConfig(level=logging.INFO)
    logger = logging.getLogger(__name__)
    
    app = Flask(__name__)
    
    class Config:
        KEYCLOAK_URL = os.getenv('KEYCLOAK_URL', 'http://keycloak:8080')
        KEYCLOAK_REALM = os.getenv('KEYCLOAK_REALM', 'master')
        KEYCLOAK_CLIENT = os.getenv('KEYCLOAK_CLIENT_ID', 'admin-cli')
        KEYCLOAK_SECRET = os.getenv('KEYCLOAK_CLIENT_SECRET', 'admin-cli-secret')
        KEYCLOAK_ADMIN = os.getenv('KEYCLOAK_ADMIN', 'admin')
        KEYCLOAK_ADMIN_PASSWORD = os.getenv('KEYCLOAK_ADMIN_PASSWORD', 'admin123')
        
        SMTP_HOST = os.getenv('SMTP_HOST', 'postfix')
        SMTP_PORT = int(os.getenv('SMTP_PORT', '25'))
        SMTP_FROM = os.getenv('SMTP_FROM', 'ceres@company.local')
        
        WG_SERVER_IP = os.getenv('WG_SERVER_IP', '192.168.1.3')
        WG_PUBLIC_KEY = os.getenv('WG_PUBLIC_KEY', '')
        WG_ENDPOINT = os.getenv('WG_ENDPOINT', '192.168.1.3:51820')
        
        CONFIG_STORAGE = '/data/wg-configs'
    
    config = Config()
    Path(config.CONFIG_STORAGE).mkdir(parents=True, exist_ok=True)
    
    class KeycloakManager:
        def __init__(self, cfg):
            self.cfg = cfg
            self.token = None
            self.token_expires = 0
        
        def get_token(self):
            if time.time() < self.token_expires and self.token:
                return self.token
            
            url = f"{self.cfg.KEYCLOAK_URL}/realms/{self.cfg.KEYCLOAK_REALM}/protocol/openid-connect/token"
            data = {
                'client_id': self.cfg.KEYCLOAK_CLIENT,
                'client_secret': self.cfg.KEYCLOAK_SECRET,
                'username': self.cfg.KEYCLOAK_ADMIN,
                'password': self.cfg.KEYCLOAK_ADMIN_PASSWORD,
                'grant_type': 'password'
            }
            
            try:
                resp = requests.post(url, data=data, timeout=10)
                if resp.status_code == 200:
                    self.token = resp.json()['access_token']
                    self.token_expires = time.time() + 3600
                    return self.token
            except Exception as e:
                logger.error(f"Keycloak token error: {e}")
            return None
        
        def get_user_email(self, user_id):
            token = self.get_token()
            if not token:
                return None
            
            headers = {'Authorization': f'Bearer {token}'}
            url = f"{self.cfg.KEYCLOAK_URL}/admin/realms/{self.cfg.KEYCLOAK_REALM}/users/{user_id}"
            
            try:
                resp = requests.get(url, headers=headers, timeout=10)
                if resp.status_code == 200:
                    return resp.json().get('email')
            except Exception as e:
                logger.error(f"Get email error: {e}")
            return None
    
    class WireGuardManager:
        def __init__(self, cfg):
            self.cfg = cfg
        
        def generate_keypair(self):
            try:
                privkey = subprocess.check_output(['wg', 'genkey']).decode().strip()
                pubkey = subprocess.check_output(
                    f'echo {privkey} | wg pubkey',
                    shell=True
                ).decode().strip()
                return privkey, pubkey
            except Exception as e:
                logger.error(f"Key generation error: {e}")
                return None, None
        
        def create_user_config(self, username, user_email, client_privkey):
            ip = self._get_next_vpn_ip()
            config = f"""[Interface]
    PrivateKey = {client_privkey}
    Address = 10.8.0.{ip}/32
    DNS = 8.8.8.8, 8.8.4.4
    
    [Peer]
    PublicKey = {self.cfg.WG_PUBLIC_KEY}
    AllowedIPs = 10.8.0.0/24, 192.168.1.0/24
    Endpoint = {self.cfg.WG_ENDPOINT}
    PersistentKeepalive = 25
    """
            return config
        
        def _get_next_vpn_ip(self):
            try:
                configs = Path(self.cfg.CONFIG_STORAGE).glob('*.conf')
                ips = set()
                for conf_file in configs:
                    with open(conf_file) as f:
                        content = f.read()
                        if 'Address = 10.8.0.' in content:
                            ip = content.split('Address = 10.8.0.')[1].split('/')[0]
                            try:
                                ips.add(int(ip))
                            except:
                                pass
                next_ip = max(ips) + 1 if ips else 10
                return next_ip if next_ip <= 254 else 10
            except:
                return 10
    
    class EmailManager:
        def __init__(self, cfg):
            self.cfg = cfg
        
        def send_wg_config(self, recipient_email, username, wg_config):
            try:
                msg = MIMEMultipart('alternative')
                msg['Subject'] = f'WireGuard VPN конфиг для {username}'
                msg['From'] = self.cfg.SMTP_FROM
                msg['To'] = recipient_email
                
                text = f"""Здравствуйте, {username}!

    Вашему аккаунту добавлена конфигурация для подключения к корпоративной VPN (WireGuard).
    
    Инструкции:
    1. Скачайте WireGuard: https://www.wireguard.com/install/
    2. Установите приложение
    3. Импортируйте прилагаемый конфиг (файл wg-config.conf)
    4. Активируйте туннель в приложении WireGuard
    
    С уважением,
    Администрация CERES"""
                
                msg.attach(MIMEText(text, 'plain'))
                
                with smtplib.SMTP(self.cfg.SMTP_HOST, self.cfg.SMTP_PORT) as server:
                    server.send_message(msg)
                
                logger.info(f"Email sent to {recipient_email}")
                return True
            except Exception as e:
                logger.error(f"Email error: {e}")
                return False
    
    keycloak = KeycloakManager(config)
    wireguard = WireGuardManager(config)
    email = EmailManager(config)
    
    def require_auth(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            auth_header = request.headers.get('Authorization', '')
            expected_token = os.getenv('API_TOKEN', 'secret-token')
            
            if not auth_header.startswith('Bearer '):
                return jsonify({'error': 'Unauthorized'}), 401
            
            token = auth_header.split(' ')[1]
            if token != expected_token:
                return jsonify({'error': 'Invalid token'}), 401
            
            return f(*args, **kwargs)
        return decorated_function
    
    @app.route('/health', methods=['GET'])
    def health():
        return jsonify({'status': 'ok', 'timestamp': datetime.now().isoformat()})
    
    @app.route('/api/v1/user/register', methods=['POST'])
    @require_auth
    def register_user():
        try:
            data = request.get_json()
            user_id = data.get('user_id')
            username = data.get('username')
            user_email = data.get('email')
            
            if not all([user_id, username, user_email]):
                return jsonify({'error': 'Missing fields'}), 400
            
            client_privkey, client_pubkey = wireguard.generate_keypair()
            if not client_privkey:
                return jsonify({'error': 'Failed to generate keypair'}), 500
            
            wg_config = wireguard.create_user_config(username, user_email, client_privkey)
            
            config_file = Path(config.CONFIG_STORAGE) / f"{user_id}.conf"
            config_file.write_text(wg_config)
            config_file.chmod(0o600)
            
            email.send_wg_config(user_email, username, wg_config)
            
            metadata = {
                'user_id': user_id,
                'username': username,
                'email': user_email,
                'public_key': client_pubkey,
                'created_at': datetime.now().isoformat(),
                'enabled': True
            }
            
            metadata_file = Path(config.CONFIG_STORAGE) / f"{user_id}.json"
            metadata_file.write_text(json.dumps(metadata, indent=2))
            
            return jsonify({'status': 'registered', 'message': f'Config sent to {user_email}'}), 201
        
        except Exception as e:
            logger.error(f"Register error: {e}")
            return jsonify({'error': str(e)}), 500
    
    @app.route('/api/v1/user/<user_id>/disable', methods=['POST'])
    @require_auth
    def disable_user(user_id):
        try:
            metadata_file = Path(config.CONFIG_STORAGE) / f"{user_id}.json"
            
            if not metadata_file.exists():
                return jsonify({'error': 'User not found'}), 404
            
            with open(metadata_file) as f:
                metadata = json.load(f)
            
            metadata['enabled'] = False
            metadata['disabled_at'] = datetime.now().isoformat()
            metadata_file.write_text(json.dumps(metadata, indent=2))
            
            return jsonify({'status': 'disabled', 'user_id': user_id}), 200
        
        except Exception as e:
            logger.error(f"Disable error: {e}")
            return jsonify({'error': str(e)}), 500
    
    @app.route('/api/v1/users', methods=['GET'])
    @require_auth
    def list_users():
        try:
            configs = Path(config.CONFIG_STORAGE).glob('*.json')
            users = []
            
            for cfg_file in configs:
                with open(cfg_file) as f:
                    metadata = json.load(f)
                    users.append(metadata)
            
            return jsonify({'users': users, 'total': len(users)}), 200
        
        except Exception as e:
            logger.error(f"List error: {e}")
            return jsonify({'error': str(e)}), 500
    
    if __name__ == '__main__':
        port = int(os.getenv('PORT', '5000'))
        logger.info(f"Starting WireGuard Config Manager on port {port}")
        app.run(host='0.0.0.0', port=port, debug=False)
