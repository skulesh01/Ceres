# Job –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ë–î (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π)
apiVersion: batch/v1
kind: Job
metadata:
  name: create-databases
  namespace: ceres-core
spec:
  ttlSecondsAfterFinished: 60  # Auto-cleanup after 1 minute
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: createdb
        image: postgres:16
        env:
        - name: PGPASSWORD
          value: ceres_postgres_2025
        - name: PGHOST
          value: postgresql.ceres-core.svc.cluster.local
        - name: PGUSER
          value: postgres
        command:
        - /bin/bash
        - -c
        - |
          echo "üóÑÔ∏è  –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤..."
          
          # –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –ë–î (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è)
          create_db() {
            local dbname=$1
            psql -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = '$dbname'" | grep -q 1 && {
              echo "  ‚úì $dbname —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            } || {
              psql -d postgres -c "CREATE DATABASE $dbname;" && echo "  ‚úÖ $dbname —Å–æ–∑–¥–∞–Ω–∞"
            }
          }
          
          # –°–æ–∑–¥–∞—ë–º –≤—Å–µ –ë–î
          create_db redmine
          create_db wikijs
          create_db mattermost
          create_db nextcloud
          create_db gitlab
          create_db sonarqube
          
          echo ""
          echo "üìä –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö:"
          psql -d postgres -c "\l" | grep -E "redmine|wikijs|mattermost|nextcloud|gitlab|sonarqube"
          
          echo ""
          echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
