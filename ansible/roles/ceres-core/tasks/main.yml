---
# Role: ceres-core
# Deploys Core services (PostgreSQL, Redis, Keycloak)

- name: Clone CERES repository
  git:
    repo: "{{ ceres_git_repo }}"
    dest: "{{ ceres_install_path }}"
    version: "{{ ceres_git_branch }}"
    force: yes
  become_user: ceres

- name: Create .env file from template
  template:
    src: env.j2
    dest: "{{ ceres_install_path }}/config/.env"
    owner: ceres
    group: ceres
    mode: '0600'

- name: Generate secrets if not present
  shell: |
    cd {{ ceres_install_path }}
    if [ ! -f config/.env.secrets ]; then
      openssl rand -base64 32 > config/.env.secrets
    fi
  args:
    creates: "{{ ceres_install_path }}/config/.env.secrets"
  become_user: ceres

- name: Pull Docker images
  docker_compose:
    project_src: "{{ ceres_install_path }}"
    files:
      - config/compose/base.yml
      - config/compose/core.yml
    pull: yes
  become_user: ceres

- name: Start Core services
  docker_compose:
    project_src: "{{ ceres_install_path }}"
    project_name: ceres
    files:
      - config/compose/base.yml
      - config/compose/core.yml
    state: present
  become_user: ceres

- name: Wait for PostgreSQL to be ready
  wait_for:
    port: 5432
    host: localhost
    timeout: 120
    delay: 10

- name: Wait for Redis to be ready
  wait_for:
    port: 6379
    host: localhost
    timeout: 60
    delay: 5

- name: Wait for Keycloak to be ready
  uri:
    url: http://localhost:8080/health/ready
    status_code: 200
  retries: 30
  delay: 10
  register: keycloak_health
  until: keycloak_health.status == 200

- name: Display Core services status
  debug:
    msg: "Core services are running on {{ inventory_hostname }}"
