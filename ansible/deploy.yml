---
# CERES Main Deployment Playbook
# Deploys full CERES stack to 3-VM cluster

- name: CERES Pre-flight Checks
  hosts: all
  gather_facts: yes
  become: yes
  tasks:
    - name: Check connectivity
      ping:
      
    - name: Display target hosts
      debug:
        msg: "Deploying to {{ inventory_hostname }} ({{ ansible_host }})"

- name: Prepare All VMs
  hosts: ceres_cluster
  gather_facts: yes
  become: yes
  roles:
    - common
    - docker
    - monitoring-agent
  tags:
    - prepare

- name: Deploy Core Services
  hosts: core_vms
  gather_facts: yes
  become: yes
  serial: 1  # Deploy one at a time for safety
  roles:
    - ceres-core
  tags:
    - core
    - deploy

- name: Deploy Application Services
  hosts: apps_vms
  gather_facts: yes
  become: yes
  serial: 1
  roles:
    - ceres-apps
  tags:
    - apps
    - deploy

- name: Deploy Edge & Monitoring
  hosts: edge_vms
  gather_facts: yes
  become: yes
  roles:
    - ceres-edge
    - ceres-monitoring
  tags:
    - edge
    - monitoring
    - deploy

- name: Post-Deployment Configuration
  hosts: ceres_cluster
  gather_facts: no
  become: yes
  tasks:
    - name: Wait for all services to be healthy
      wait_for:
        port: "{{ item }}"
        host: "{{ ansible_host }}"
        timeout: 300
      loop:
        - 80
        - 443
      when: vm_role == 'edge'
      
    - name: Display access URLs
      debug:
        msg: "CERES is ready at https://{{ ceres_domain }}"
      run_once: yes
  tags:
    - post-deploy

- name: Health Check
  hosts: edge_vms
  gather_facts: no
  become: yes
  tasks:
    - name: Check service endpoints
      uri:
        url: "http://localhost/health"
        status_code: 200
      retries: 5
      delay: 10
      register: health_check
      
    - name: Display health status
      debug:
        msg: "Health check: {{ health_check.status }}"
  tags:
    - health-check
