# Day-1 Mail (SMTP) для CERES

Цель этого документа — **быстро включить email-уведомления** (reset password, verify email, приглашения) в CERES за 30–60 минут.

Важно: это **не** про «полный self-host почтовый сервер для ящиков». Для Day-1 это почти всегда слишком долго и плохо по доставляемости.

## 1) Что именно настраиваем

В Day-1 мы настраиваем **SMTP для Keycloak** (как минимум):

- сброс пароля (Forgot password)
- email-верификация
- email-действия админки

CERES читает SMTP настройки из `config/.env` (переменные `SMTP_*`) и применяет их в Keycloak.

## 2) Рекомендуемые варианты SMTP (по скорости/простоте)

### Вариант A (лучший для Day-1): SMTP Relay сервис

Подходит, если у вас есть домен, но нет готовой доменной почты или вы не хотите возиться.

Примеры классов сервисов: SMTP relay / transactional email.

Что получите:

- высокая доставляемость
- минимум инфраструктуры
- простая “замена провайдера” при необходимости

Типовые настройки:

- порт `587`
- `STARTTLS=true`
- авторизация по ключу/паролю

### Вариант B: SMTP доменной почты (Google Workspace / Microsoft 365 / Zoho / Яндекс 360 и т.п.)

Подходит, если у вас уже куплена доменная почта.

Что получите:

- письма уходят от вашего домена
- можно использовать “пароль приложения”

Типовые настройки:

- порт `587`
- `STARTTLS=true`

### Вариант C: “почта на домашнем сервере” (не рекомендуется в Day-1)

Причины:

- часто провайдер блокирует TCP 25, либо CGNAT
- нужна DNS гигиена (SPF/DKIM/DMARC), репутация IP
- антиспам/антивирус/серые списки

## 3) Минимальные DNS настройки для “письма от вашего домена”

Для Day-1 достаточно:

- SPF (TXT для домена отправителя)
- DKIM (если ваш SMTP/relay его даёт)
- DMARC (минимальный, чтобы отчёты/политика были)

Пока нет точного провайдера — не фиксируем конкретные записи.

## 4) Какие значения вводить в CERES

Заполните в `config/.env` блок `SMTP_*`:

- `SMTP_HOST` — адрес SMTP сервера
- `SMTP_PORT` — обычно `587` (STARTTLS) или `465` (SSL)
- `SMTP_FROM` — адрес отправителя (обычно `no-reply@your-domain`)
- `SMTP_USER` / `SMTP_PASSWORD` — если есть авторизация
- `SMTP_STARTTLS` — обычно `true` для `587`
- `SMTP_SSL` — обычно `true` для `465`

Рекомендованные дефолты для Day-1:

- `SMTP_PORT=587`
- `SMTP_STARTTLS=true`
- `SMTP_SSL=false`

## 5) Применить SMTP к Keycloak

Самый надёжный способ (не зависит от резолва `auth.<DOMAIN>` на хосте):

- `cd f:\Ceres\scripts`
- `./keycloak-smtp.ps1 -EnvFile ..\config\.env -ProjectName ceres -Realm master`

Скрипт:

- спросит параметры (если не заполнены)
- запишет их в `config/.env`
- применит настройки через `kcadm.sh` внутри контейнера Keycloak

## 6) Проверка

В Keycloak:

- Realm settings → Email → Test connection

А затем (практический тест):

- попробуйте “Forgot password” для тестового пользователя

## 7) Когда всё-таки нужен self-host mailserver

Если бизнес-требование — «свои ящики» (IMAP), входящая почта и т.п., это отдельный модуль/этап.

Практический критерий готовности:

- есть статический IP или VPS
- нет CGNAT
- открыты входящие порты
- готовы настроить DNS (MX/SPF/DKIM/DMARC) и принять риски спама
